# **Processing Multiplex SRT Sequencing Data to TF Binding Sites and Visualization**

## **Order to run scripts**

1. ### **step\_1\_raw\_qbed\_to\_insertion\_maps.py**

   * **Main goal:** A comprehensive, annotation-driven script that processes raw qbed files into final, 1-bp resolution insertion maps for each experimental group. It performs barcode correction, annotation, fragment-based peak calling (to define regions of interest), and precise insertion site mapping.  
     * **INPUT:** Raw qbed/bed file(s) and an annotation file.  
     * **OUTPUT:** Per-sample and per-group raw and normalized insertion counts as bedgraph and bigwig files, and per-group insertion coordinates as a qbed file.

2. ### **step\_2\_run\_span\_peak\_caller.sh**

   * **Main goal:** Call peaks on the group-level insertion data generated by Step 1\. This step uses the SPAN2.0 peak caller to identify regions of significantly concentrated insertions for each group, without background subtraction.  
     * **INPUT:** The per-group insertion coordinates qbed file from Step 1\.  
     * **OUTPUT:** Peak files (.peak) for each group, representing putative TF binding sites.

3. ### **step\_3\_generate\_peak\_by\_group\_count\_matrices.py**

   * **Main goal:** Quantify the signal within the peaks defined in Step 2\. For each group's peak set, this script counts the number of insertions from *every* other group (including controls), creating comprehensive count matrices.  
     * **INPUT:** Per-group peak files from Step 2 and per-group insertion count bedgraph files from Step 1\.  
     * **OUTPUT:** A peak-by-group insertion count matrix for each group's peak set.

4. ### **step\_4\_DESeq2\_Diff\_Peaks\_HOMER-Annotations\_and\_Motifs.R**

   * **Main goal:** Perform extensive downstream analysis, including differential peak calling, peak annotation, and motif discovery. This script defines final TF binding sites by comparing experimental groups to a control, identifies group-specific peaks, annotates peak locations with HOMER, and performs motif enrichment analysis.  
     * **INPUT:** Peak-by-group count matrices from Step 3 and the annotation file.  
     * **OUTPUT:** Final lists of significant and group-specific peaks, comprehensive summary tables, publication-quality plots (heatmaps, bar plots), and HOMER annotation/motif analysis results.

\<img width="4000" height="3670" alt="overview\_of\_analysis\_method\_07-11-2025" src="[https://github.com/user-attachments/assets/38bfe237-9f1b-4b1a-b39c-f5b79d9da212](https://github.com/user-attachments/assets/38bfe237-9f1b-4b1a-b39c-f5b79d9da212)" /\>

## **Table of Contents**

* [Overview of the Method](https://www.google.com/search?q=%23overview-of-the-method)  
* [Script 1: step\_1\_raw\_qbed\_to\_insertion\_maps.py](https://www.google.com/search?q=%23script-1-step_1_raw_qbed_to_insertion_maps.py)  
* [Script 2: step\_2\_run\_span\_peak\_caller.sh](https://www.google.com/search?q=%23script-2-step_2_run_span_peak_callersh)  
* [Script 3: step\_3\_generate\_peak\_by\_group\_count\_matrices.py](https://www.google.com/search?q=%23script-3-step_3_generate_peak_by_group_count_matricespy)  
* [Script 4: step\_4\_DESeq2\_Diff\_Peaks\_HOMER-Annotations\_and\_Motifs.R](https://www.google.com/search?q=%23script-4-step_4_deseq2_diff_peaks_homer-annotations_and_motifsr)

## **Overview of the Method**

* This method leverages self-reporting transposon (SRT) technology.  
* An SRT is "self-reporting" because it contains a promoter that drives the transcription of RNA containing the junction of the transposon's terminal repeat and the downstream genomic DNA.  
* Sequencing this RNA maps the transposon insertion site, which represents the approximate TF binding site.

The method is antibody-independent and semi-multiplexed. Because both the sample barcode and the SRT barcode are inserted into genomic DNA, cells from different conditions can be combined following transfection/electroporation if they have distinct sample barcodes.

**Workflow Summary:**

1. **Transfection:** Samples are transfected with a large, diverse pool of plasmids. Each pool contains a unique sample barcode but many SRT barcodes.  
2. **Pooling:** All samples, each with its unique sample barcode, are pooled after transfection.  
3. **Library Prep & Sequencing:** The workflow is RNA extraction, cDNA synthesis, SRT amplification, library preparation, and 2x150bp sequencing.  
4. **Demultiplexing:** Post-sequencing, reads are assigned to their original samples based on the sample barcode.  
5. **Mapping:** The unique transposon insertion sites are identified by their genomic coordinates and the SRT barcode, representing the location and signal of a TF binding event, respectively.

## **Script 1: step\_1\_raw\_qbed\_to\_insertion\_maps.py**

This is a comprehensive, annotation-driven calling card data processing pipeline that combines peak calling and insertion mapping into a single, streamlined workflow.

**Major steps:**

1. Input loading, barcode correction, annotation, and per-sample partitioning.  
2. For each sample:  
   a. Fragment-based peak calling to identify regions of interest.  
   b. Generation of 1-bp unique insertion site maps using strand-aware logic.  
3. Aggregation of insertion maps by experimental group.  
4. Generation of bedGraph, BigWig, and qbed files for visualization and downstream analysis.

### **Dependencies**

| Package | Version |
| :---- | :---- |
| polars | 1.31.0 |
| pandas | 2.2.3 |
| pybedtools | 0.12.0 |
| pycallingcards | 1.0.0 |
| UMI-tools | 1.1.6 |
| tqdm | 4.67.1 |
| numpy | 1.26.4+ |
| pyBigWig | 0.3.22+ |
| bedtools | 2.31.1 |
| bedGraphToBigWig | (any) |

### **Usage**

python step\_1\_raw\_qbed\_to\_insertion\_maps.py \\  
    \--input\_dir /path/to/qbed\_files \\  
    \--output\_dir /path/to/results \\  
    \--annotation\_file /path/to/annotation\_file.tsv \\  
    \--chrom\_sizes /path/to/hg38.chrom.sizes \\  
    \--workers 10 \\  
    \--sample\_barcode\_dist\_threshold 2 \\  
    \--srt\_bc\_dist\_threshold 1 \\  
    \--min\_rows\_threshold 50000 \\  
    \--sum\_window\_size 50

### **Arguments**

* \--input\_dir: Directory containing input .qbed, .bed, .qbed.gz, or .bed.gz files.  
* \--output\_dir: Directory where output files will be written.  
* \--annotation\_file: Path to the annotation file (TSV/CSV with header: library\_name,sample\_barcode,sample\_name,group\_name).  
* \--chrom\_sizes: Path to a chromosome sizes file (e.g., hg38.chrom.sizes).  
* \--workers: Number of parallel worker processes (default: 10).  
* \--sample\_barcode\_dist\_threshold: Max Hamming distance for correcting sample barcodes (default: 2).  
* \--srt\_bc\_dist\_threshold: Max Hamming distance for SRT barcode (UMI) clustering (default: 1).  
* \--min\_rows\_threshold: Minimum number of fragments for a sample to be processed (default: 50000).  
* \--sum\_window\_size: Window size (bp) for binned summary BigWig tracks (default: 50).  
* Additional parameters for the internal pycallingcards peak caller (--pvalue\_cutoff, \--extend, etc.) are available.

### **Core Logic: Defining the 1-bp Insertion Site**

For each unique SRT barcode within a preliminarily called fragment-based peak, the script identifies the single coordinate most proximal to the actual insertion event based on strand:

* For **'+' strand** fragments, the read direction is 5' \<- 3'. The end coordinate in the qbed is the true end of the read. The script selects the **minimum end coordinate** across all fragments for that SRT barcode.  
* For **'-' strand** fragments, the read direction is 5' \-\> 3'. The start coordinate in the qbed is the true end of the read. The script selects the **maximum start coordinate** across all fragments for that SRT barcode.

This process results in a single, representative 1-bp coordinate for each unique insertion event.

### **Output Directories**

* collapsed\_fragments\_per\_sample/: Intermediate partitioned data for each sample.  
* fragment\_peaks\_per\_sample/: Intermediate fragment-based peaks for each sample.  
* raw\_unique\_insertions\_per\_sample\_bedgraph/ & ...\_bigwig/  
* raw\_unique\_insertion\_count\_per\_group\_bedgraph/ & ...\_bigwig/  
* raw\_unique\_insertion\_count\_per\_group\_qbed/: **Input for Step 2\.**  
* size\_normalized\_unique\_insertions\_per\_group\_bedgraph/ & ...\_bigwig/  
* binned\_normalized\_count\_sum\_bigwig.../: Optional binned tracks for visualization.

## **Script 2: step\_2\_run\_span\_peak\_caller.sh**

This script runs the SPAN peak caller on the per-group qbed files generated in Step 1 to identify regions of significant insertion concentration.

### **Usage**

bash step\_2\_run\_span\_peak\_caller.sh \\  
    \-j /path/to/span.jar \\  
    \-i /path/to/step1/raw\_unique\_insertion\_count\_per\_group\_qbed \\  
    \-o /path/to/span\_peak\_output \\  
    \-c /path/to/hg38.chrom.sizes \\  
    \-b 50 \\  
    \-f 0.01

### **Arguments**

* \-j: Path to the SPAN jar file.  
* \-i: Input directory containing .qbed files from Step 1\.  
* \-o: Directory for output peak files.  
* \-c: Path to the chromosome sizes file.  
* \-b: Bin size for SPAN analysis (default: 50).  
* \-f: False Discovery Rate (FDR) cutoff (default: 0.01).

### **Output**

* A .span.peak file for each input group, containing the coordinates of called peaks. This is the **input for Step 3**.

## **Script 3: step\_3\_generate\_peak\_by\_group\_count\_matrices.py**

This script takes the peaks called for each group (from Step 2\) and quantifies the number of insertions from all other groups that fall within those peaks, creating all-vs-all count matrices.

### **Dependencies**

* polars, pandas, pybedtools, tqdm

### **Usage**

python step\_3\_generate\_peak\_by\_group\_count\_matrices.py \\  
    \--peak\_dir /path/to/span\_peak\_output \\  
    \--peak\_suffix \_b50.span.peak \\  
    \--bedgraph\_dir /path/to/step1/raw\_unique\_insertion\_count\_per\_group\_bedgraph \\  
    \--output\_dir /path/to/peak\_matrices\_output \\  
    \--annotation\_file /path/to/annotation\_file.tsv \\  
    \--workers 12

### **Arguments**

* \--peak\_dir: Directory containing SPAN peak files from Step 2\.  
* \--peak\_suffix: Suffix of the peak files to use (e.g., \_b50.span.peak).  
* \--bedgraph\_dir: Directory with per-group bedGraph files from Step 1\.  
* \--output\_dir: Directory to save output files.  
* \--annotation\_file: The same annotation file used previously.  
* \--workers: Number of parallel worker processes.

### **Output**

* per\_group\_peak\_matrices/: A directory containing a TSV file for each experimental group (e.g., GroupName\_peak\_matrix.tsv). Each file is a matrix with the group's peaks as rows and insertion counts from all groups as columns. This is the **input for Step 4**.

## **Script 4: step\_4\_DESeq2\_Diff\_Peaks\_HOMER-Annotations\_and\_Motifs.R**

This is the final analysis script that performs differential analysis, annotation, and visualization.

### **Workflow**

1. **Normalization:** Calculates size factors from total raw insertions and normalizes the count matrices from Step 3\.  
2. **Differential Analysis:** Uses DESeq2 to perform pairwise comparisons for each group's peak set against a control group and all other experimental groups.  
3. **Significant Peak Identification:** Filters results to identify peaks significantly enriched over the control (HyPBase) and peaks that are group-specific.  
4. **Peak Annotation & Motif Analysis:** Uses HOMER to annotate the genomic location of significant peaks and perform *de novo* motif discovery.  
5. **Visualization:** Generates publication-quality heatmaps and summary bar plots.

### **Key Outputs**

* DESeq2\_results\_by\_group/: Detailed DESeq2 results for all pairwise comparisons.  
* normalized\_peak\_matrices/: The normalized count matrices.  
* COMBINED\_all\_Group\_vs\_Control\_results.csv: A master table of all peaks found to be significant over the control.  
* group\_specific\_peaks\_summary.csv: A master table of peaks found to be specific to a single group compared to all others.  
* HOMER/: A directory containing:  
  * Per\_Group\_Annotations/: Genomic annotation for each group's significant peaks.  
  * HOMER\_motif\_discovery/: Motif enrichment results.  
  * HOMER\_promoter\_bound\_genes...csv: Lists of protein-coding genes with significant peaks in their promoter regions.  
* **Plots:**  
  * heatmap\_group\_specific\_peaks.png: Heatmap of Z-scored normalized counts for group-specific peaks.  
  * heatmap\_merged\_peaks\_vs\_Control.png: Heatmap of peaks significantly above control.  
  * total\_raw\_insertions\_per\_group\_barplot.png: Bar plot of library sizes.  
  * significant\_peaks\_per\_group\_barplot.png: Bar plot of the number of significant peaks per group.  
  * HOMER\_genomic\_annotation\_proportions\_plot.png: Stacked bar plot of peak distributions.  
  * homer\_top\_motifs\_plot.png: Top 10 enriched motifs for each group.
