# Figure 3: DESeq2 ACR-Gene Pairs Full Analysis with Heatmaps (Generalizable Paths)

suppressPackageStartupMessages({
  library(scales)
  library(future)
  library(progress)
  library(progressr)
  library(ChIPseeker)
  library(readr)
  library(data.table)
  library(purrr)
  library(stringr)
  library(tibble)
  library(ArchR)
  library(dplyr)
  library(future.apply)
  library(broom)
  library(Matrix)
  library(tidyverse)
  library(GenomicRanges)
  library(TxDb.Hsapiens.UCSC.hg38.knownGene)
  library(org.Hs.eg.db)
  library(patchwork)
  library(DESeq2)
  library(parallel)
  library(ComplexHeatmap)
  library(tidytext)
  library(RColorBrewer)
  library(circlize)
  library(viridis)
  library(janitor)
  library(R.utils)
  library(annotatr)
  library(tidyr)
  library(AnnotationHub)
  library(GenomicFeatures)
  library(EnhancedVolcano)
  library(biomaRt)
  library(pathview)
  library(ggplot2)
  library(GSVA)
  library(forcats)
  library(enrichplot)
  library(clusterProfiler)
  library(ReactomePA)
  library(DOSE)
  library(AUCell)
  library(scCustomize)
  library(gridExtra)
  library(GENIE3)
  library(ggpubr)
  library(fgsea)
  library(msigdbr)
  library(patchwork)
  library(qs)
  library(RColorBrewer)
  library(UpSetR)
  library(doRNG)
  library(sctransform)
  library(rlang)
  library(cli)
  library(ggraph)
  library(ggthemes)
  library(magrittr)
  library(tictoc)
  library(rstatix)
  library(cowplot)
  library(harmony)
  library(DESeq2)
  library(rhdf5)
  library(Seurat)
  library(SeuratObject)
  options(Seurat.object.assay.version = "v5")
  options(future.globals.maxSize = 1e9)
})

# Generalizable directories
input_dir <- "./input"
output_dir <- "./output"
figdir <- file.path(output_dir, "figures")
dir.create(figdir, recursive = TRUE, showWarnings = FALSE)
bulk_rna_dir <- file.path(output_dir, "wherry_bulk_rna_seq_analysis")
bulk_atac_dir <- file.path(output_dir, "wherry_bulk_atac_analysis")
bzip_results_outdir <- file.path(bulk_atac_dir, "bZIP_combined_linear_regression")
dir.create(bzip_results_outdir, recursive = TRUE, showWarnings = FALSE)

promoter_upstream <- 5000
promoter_downstream <- 5000

dt <- fread(file=file.path(input_dir, "distinct_gene_pairs_unmerged_final.csv"), nThread = 12) %>%
  distinct(enh_coord, chr, start, end, gene_name)

annot_ac <- read.csv(file.path(input_dir, "HOMER_annotations_COMBINED_all_Group_vs_Control_results_acute.csv"))
annot_ch <- read.csv(file.path(input_dir, "HOMER_annotations_COMBINED_all_Group_vs_Control_results_chronic.csv"))
annot <- rbind(annot_ac,annot_ch)

mae_paired <- readRDS(file = file.path(bulk_atac_dir, "wherry_data_paired_rna_atac_multi_assay_experiment.rds"))

group_annotation_file <- file.path(bulk_atac_dir, "all_acrs_HOMER_annotated.txt")
se_rna <- mae_paired[["rna"]]
se_atac <- mae_paired[["atac"]]
colnames(se_atac) <- mae_paired[["atac"]]$RNA_ID
atac_mat <- assay(se_atac)
rna_mat <- assay(se_rna)
rownames(rna_mat) <- rowData(se_rna)$geneSymbol
rna_mat <- rna_mat[!duplicated(rownames(rna_mat)), ]

acr_annot <- fread(group_annotation_file) %>%
  rename_with(~ gsub(" ", "_", .)) %>%
  dplyr::mutate(acr_id = paste0(Chr, "_", Start, "_", End)) %>%
  dplyr::select(acr_id, Chr, Start, End) %>%
  distinct()

get_universe_overlaps <- function(tf_peak_df, universe_gr, maxgap = 0) {
    if (nrow(tf_peak_df) == 0) return(character(0))
    tf_gr <- tf_peak_df %>%
        separate(peak_id, into = c("chr", "start", "end"), sep = "[_:-]", convert = TRUE, fill = "right") %>%
        filter(!is.na(chr) & !is.na(start) & !is.na(end)) %>%
        makeGRangesFromDataFrame()
    hits <- findOverlaps(tf_gr, universe_gr, maxgap = maxgap)
    unique(mcols(universe_gr)$peak_id[subjectHits(hits)])
}

all_acrs_gr <- acr_annot %>%
  mutate(peak_id = acr_id) %>%
  dplyr::rename(chr = Chr, start = Start, end = End) %>%
  makeGRangesFromDataFrame(keep.extra.columns = TRUE)

tf_groups <- c("TOX_Acute", "TCF7_Acute","TOX2_Acute","SOX4_Acute","RBPJ_Acute",
               "TOX_Chronic","TCF7_Chronic","TOX2_Chronic","SOX4_Chronic")
tf_bound_acrs_list <- lapply(tf_groups, function(tf) {
  peaks_df <- annot %>% filter(group == tf)
  get_universe_overlaps(peaks_df, all_acrs_gr)
})
tf_bound_acrs <- unique(unlist(tf_bound_acrs_list))
all_acrs_gr <- all_acrs_gr[mcols(all_acrs_gr)$peak_id %in% tf_bound_acrs]

cat("Using", length(tf_groups), "TFs:", paste(tf_groups, collapse=", "), "\n")
cat("Found", length(tf_bound_acrs), "unique TF-bound ACRs to use for pairing\n")

txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
genes_gr <- genes(txdb)
gene_map <- AnnotationDbi::select(org.Hs.eg.db, keys = genes_gr$gene_id, columns = "SYMBOL", keytype = "ENTREZID")
mcols(genes_gr)$gene_symbol <- gene_map$SYMBOL[match(genes_gr$gene_id, gene_map$ENTREZID)]
genes_gr <- genes_gr[!is.na(mcols(genes_gr)$gene_symbol) & mcols(genes_gr)$gene_symbol %in% rownames(rna_mat)]

promoter_windows <- promoters(genes_gr, upstream = promoter_upstream, downstream = promoter_downstream)
promoter_hits <- findOverlaps(all_acrs_gr, promoter_windows)
promoter_pairs <- data.frame(
  acr_id = mcols(all_acrs_gr)$peak_id[queryHits(promoter_hits)],
  gene_name = mcols(promoter_windows)$gene_symbol[subjectHits(promoter_hits)]
) %>% distinct()

enhancer_db_gr <- makeGRangesFromDataFrame(dt, seqnames.field = "chr", start.field = "start", end.field = "end", keep.extra.columns = TRUE)
enhancer_hits <- findOverlaps(all_acrs_gr, enhancer_db_gr)
enhancer_pairs <- data.frame(
  acr_id = mcols(all_acrs_gr)$peak_id[queryHits(enhancer_hits)],
  gene_name = mcols(enhancer_db_gr)$gene_name[subjectHits(enhancer_hits)]
) %>% distinct()

all_candidate_pairs <- bind_rows(promoter_pairs, enhancer_pairs) %>%
  distinct(acr_id, gene_name)
acr_gene_pairs_for_modeling <- all_candidate_pairs %>%
  mutate(is_promoter = (paste(acr_id, gene_name) %in% paste(promoter_pairs$acr_id, promoter_pairs$gene_name))) %>%
  mutate(is_enhancer = (paste(acr_id, gene_name) %in% paste(enhancer_pairs$acr_id, enhancer_pairs$gene_name)))

tf_binding_info <- tibble(acr_id = tf_bound_acrs)
for (tf in tf_groups) {
  this_list <- tf_bound_acrs_list[[which(tf_groups == tf)]]
  tf_binding_info[[tf]] <- as.integer(tf_bound_acrs %in% this_list)
}

acr_gene_pairs_for_modeling <- acr_gene_pairs_for_modeling %>%
  left_join(tf_binding_info, by = "acr_id") %>%
  filter(gene_name %in% rownames(rna_mat))

cat("\nFinal number of unique ACR-gene pairs for modeling:", nrow(acr_gene_pairs_for_modeling), "\n")
cat("Number of unique ACRs in the final set:", length(unique(acr_gene_pairs_for_modeling$acr_id)), "\n")
cat("Number of unique genes in the final set:", length(unique(acr_gene_pairs_for_modeling$gene_name)), "\n\n")
print(table(Promoter = acr_gene_pairs_for_modeling$is_promoter, Enhancer = acr_gene_pairs_for_modeling$is_enhancer))

write.csv(acr_gene_pairs_for_modeling, file = file.path(figdir, "ALL_ACUTE_AND_CHRONIC_TFs_acr_gene_pairs_for_modeling.csv"), row.names = FALSE)
acr_gene_pairs_for_modeling <- read.csv(file = file.path(figdir, "ALL_ACUTE_AND_CHRONIC_TFs_acr_gene_pairs_for_modeling.csv"))

paired_acrs <- unique(acr_gene_pairs_for_modeling$acr_id)
paired_genes <- unique(acr_gene_pairs_for_modeling$gene_name)
rna_mat_filter <- rna_mat[paired_genes, , drop = FALSE]
atac_mat_filter <- atac_mat[paired_acrs, , drop = FALSE]
common_samps <- intersect(colnames(rna_mat_filter), colnames(atac_mat_filter))
if (length(common_samps) == 0) stop("No common samples between RNA and ATAC matrices.")
rna_mat_filter <- rna_mat_filter[, common_samps, drop = FALSE]
atac_mat_filter <- atac_mat_filter[, common_samps, drop = FALSE]

plan(multisession, workers = 10)
handlers(global = TRUE)
handlers("progress")

batch_size <- 10000
n_pairs <- nrow(acr_gene_pairs_for_modeling)
n_batches <- ceiling(n_pairs / batch_size)
all_model_results <- list()

with_progress({
  p_overall <- progressor(along = 1:n_batches)
  for (batch_i in 1:n_batches) {
    message(sprintf("Processing batch %d of %d", batch_i, n_batches))
    start_idx <- (batch_i - 1) * batch_size + 1
    end_idx <- min(batch_i * batch_size, n_pairs)
    batch_pairs <- acr_gene_pairs_for_modeling[start_idx:end_idx, ]
    batch_results <- future_lapply(1:nrow(batch_pairs), function(i) {
      pair <- batch_pairs[i, ]
      gene <- pair$gene_name
      acr <- pair$acr_id
      if (!(gene %in% rownames(rna_mat_filter)) || !(acr %in% rownames(atac_mat_filter))) {
        return(NULL)
      }
      expr_vec <- as.numeric(rna_mat_filter[gene, ])
      peak_vec <- as.numeric(atac_mat_filter[acr, ])
      df <- data.frame(gene_expression = expr_vec, peak_accessibility = peak_vec)
      fit <- tryCatch(lm(gene_expression ~ peak_accessibility, data = df), error = function(e) NULL)
      if (is.null(fit)) return(NULL)
      model_info <- broom::glance(fit)
      tidy_coef <- broom::tidy(fit) %>%
        filter(term == "peak_accessibility") %>%
        transmute(
          gene = gene,
          acr_id = acr,
          beta = estimate,
          p_value = p.value,
          r_squared = model_info$r.squared,
          adj_r_squared = model_info$adj.r.squared
        )
      cor_test <- suppressWarnings(cor.test(expr_vec, peak_vec, method = "spearman"))
      tidy_coef$spearman_rho <- cor_test$estimate
      tidy_coef$spearman_p <- cor_test$p.value
      tidy_coef
    }, future.seed = TRUE)
    all_model_results[[batch_i]] <- do.call(rbind, Filter(Negate(is.null), batch_results))
    p_overall(sprintf("Completed batch %d/%d", batch_i, n_batches))
    gc()
  }
})
plan(sequential)

all_model_results_merged <- dplyr::bind_rows(all_model_results) %>%
  group_by(gene) %>%
  dplyr::mutate(fdr_lm = p.adjust(p_value, method = "BH"),
         fdr_spearman = p.adjust(spearman_p, method = "BH")) %>%
  ungroup() %>%
  dplyr::select(gene, acr_id, r_squared, beta, fdr_lm, spearman_rho, fdr_spearman) %>%
  arrange(desc(abs(beta)), fdr_lm)

final_annotated_results <- all_model_results_merged %>%
  left_join(acr_gene_pairs_for_modeling, by = c("gene" = "gene_name", "acr_id" = "acr_id")) %>%
  dplyr::mutate(
    annotation = case_when(
      is_promoter == TRUE & is_enhancer == TRUE  ~ "Promoter_Enhancer",
      is_promoter == TRUE & is_enhancer == FALSE ~ "Promoter",
      is_promoter == FALSE & is_enhancer == TRUE ~ "Enhancer",
      TRUE                                      ~ "Other"
    )
  )

tf_summary <- final_annotated_results %>%
  dplyr::select(all_of(tf_groups)) %>%
  dplyr::summarise_all(~sum(., na.rm = TRUE)) %>%
  pivot_longer(cols = everything(), names_to = "Transcription_Factor", values_to = "Count") %>%
  arrange(desc(Count))
print(tf_summary)

write.csv(final_annotated_results,file = file.path(figdir,"ALL_ACUTE_AND_CHRONIC_final_annotated_results_from_acr_gene_pairs_for_modeling.csv"))
final_annotated_results <- read.csv(file = file.path(figdir,"ALL_ACUTE_AND_CHRONIC_final_annotated_results_from_acr_gene_pairs_for_modeling.csv"))

all_model_results_final <- final_annotated_results %>% filter(  fdr_lm < 0.05 & fdr_spearman < 0.05 & beta > 0.15 & r_squared > 0.15) %>%
  dplyr::mutate(abs_rho = abs(spearman_rho),
         abs_beta = abs(beta),
         acr_gene = paste0(acr_id,"_x_",gene))
nrow(all_model_results_final)
summary(all_model_results_final)

tf_summary <- all_model_results_final %>%
  dplyr::select(all_of(tf_groups)) %>%
  dplyr::summarise_all(~sum(., na.rm = TRUE)) %>%
  pivot_longer(cols = everything(), names_to = "Transcription_Factor", values_to = "Count") %>%
  arrange(desc(Count))
print(tf_summary)

write.csv(all_model_results_final,file = file.path(figdir,"ALL_ACUTE_AND_CHRONIC_FILTERED_final_annotated_results_from_acr_gene_pairs_for_modeling.csv"))
all_model_results_final<-read.csv(file = file.path(figdir,"ALL_ACUTE_AND_CHRONIC_FILTERED_final_annotated_results_from_acr_gene_pairs_for_modeling.csv"))

new_rows_list <- list()
promoter_1kb_gr <- promoters(genes_gr, upstream = 1000, downstream = 1000)
for (tf in tf_groups) {
  tf_peak_df <- annot %>% filter(group == tf)
  if (nrow(tf_peak_df) == 0) next
  tf_gr <- tf_peak_df %>%
    separate(peak_id, into = c("chr", "start", "end"), sep = "[_:-]", convert = TRUE, fill = "right") %>%
    filter(!is.na(chr) & !is.na(start) & !is.na(end)) %>%
    makeGRangesFromDataFrame()
  hits <- findOverlaps(tf_gr, promoter_1kb_gr)
  if (length(hits) == 0) next
  promoter_bound_genes_for_this_tf <- unique(mcols(promoter_1kb_gr)$gene_symbol[subjectHits(hits)])
  new_genes_to_add <- promoter_bound_genes_for_this_tf
  if (length(new_genes_to_add) > 0) {
    message(sprintf("For TF '%s', found %d new gene(s) with promoter binding not already annotated as a Promoter.", tf, length(new_genes_to_add)))
    new_df <- tibble(
      gene = new_genes_to_add,
      acr_id = NA_character_,
      annotation = "non_acr_promoter"
    )
    new_df[[tf]] <- 1
    new_rows_list[[tf]] <- new_df
  }
}
all_new_rows <- bind_rows(new_rows_list)
final_new_rows <- all_new_rows %>%
    group_by(gene, acr_id, annotation) %>%
    dplyr::summarise(across(all_of(tf_groups), ~sum(., na.rm = TRUE)), .groups = "drop")
all_model_results_final <- bind_rows(all_model_results_final, final_new_rows)
write.csv(all_model_results_final,file = file.path(figdir,"with_promoter_genes_added_back_ALL_ACUTE_AND_CHRONIC_FILTERED_final_annotated_results_from_acr_gene_pairs_for_modeling.csv"))
all_model_results_final<-read.csv(file = file.path(figdir,"with_promoter_genes_added_back_ALL_ACUTE_AND_CHRONIC_FILTERED_final_annotated_results_from_acr_gene_pairs_for_modeling.csv"))

library(eulerr)
library(ggvenn)
tox_targets  <- all_model_results_final %>% filter(TOX_Acute == 1) %>% filter(!acr_id %in% NA) %>% pull(gene) %>% unique()
tcf7_targets <- all_model_results_final %>% filter(TCF7_Acute == 1) %>% filter(!acr_id %in% NA) %>% pull(gene) %>% unique()
gene_sets <- list(TCF7 = tcf7_targets, TOX = tox_targets)
fit <- euler(gene_sets)
p <- plot(fit,
          fills = list(fill = c("skyblue", "orange"), alpha = 0.7),
          labels = list(font = 2),
          quantities = TRUE)
ggsave(file.path(figdir, "venn_diagram_tox_tcf7_genes.png"), plot = p, width = 4, height = 3, dpi = 300)
ggsave(file.path(figdir, "venn_diagram_tox_tcf7_genes.pdf"), plot = p, width = 4, height = 3, dpi = 300)

tox_targets  <- all_model_results_final %>% 
  filter(TOX_Acute == 1) %>% 
    filter(!acr_id %in% NA) %>%
  pull(acr_gene) %>% 
  unique()
tcf7_targets <- all_model_results_final %>% 
  filter(TCF7_Acute == 1) %>% 
      filter(!acr_id %in% NA) %>%
  pull(acr_gene) %>% 
  unique()
acr_gene_sets <- list(TCF7 = tcf7_targets, TOX = tox_targets)
fit <- euler(acr_gene_sets)
p <- plot(fit,
          fills = list(fill = c("skyblue", "orange"), alpha = 0.7),
          labels = list(font = 2),
          quantities = TRUE)
ggsave(file.path(figdir, "venn_diagram_tox_tcf7_peak_gene_pairs.png"),plot = p, width =4, height = 3, dpi = 300)
ggsave(file.path(figdir, "venn_diagram_tox_tcf7_peak_gene_pairs.pdf"),plot = p, width = 4, height = 3, dpi = 300)

tox_targets  <- all_model_results_final %>% 
  filter(TOX_Acute == 1) %>% 
    filter(!acr_id %in% NA) %>%
  pull(acr_id) %>% 
  unique()
tcf7_targets <- all_model_results_final %>% 
  filter(TCF7_Acute == 1) %>% 
      filter(!acr_id %in% NA) %>%
  pull(acr_id) %>% 
  unique()
acr_gene_sets <- list(TCF7 = tcf7_targets, TOX = tox_targets)
fit <- euler(acr_gene_sets)
p <- plot(fit,
          fills = list(fill = c("skyblue", "orange"), alpha = 0.7),
          labels = list(font = 2),
          quantities = TRUE)
ggsave(file.path(figdir, "venn_diagram_tox_tcf7_acrs.png"),plot = p, width =4, height = 3, dpi = 300)
ggsave(file.path(figdir, "venn_diagram_tox_tcf7_acrs.pdf"),plot = p, width = 4, height = 3, dpi = 300)

genes_of_interest <- c("TCF7", "TOX")
cluster_order <- c("Naive", "SCM-R3-", "SCM-R3+", "CM", "EM1", "EM2", "EMRA","PD1+CD39+")
plot_data_bulk <- rna_mat[genes_of_interest, , drop = FALSE] %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var = "SampleID") %>%
  left_join(
    as.data.frame(colData(se_rna)) %>% rownames_to_column(var = "SampleID"),
    by = "SampleID"
  ) %>%
  pivot_longer(
    cols = all_of(genes_of_interest),
    names_to = "Gene",
    values_to = "Expression"
  ) %>%
  dplyr::mutate(Cluster = factor(Cell_Subset, levels = cluster_order))
plot_data_bulk$Gene <- factor(plot_data_bulk$Gene, levels = c("TCF7", "TOX"))
clusters <- levels(factor(plot_data_bulk$Cluster))
turbo_colors <- viridis::turbo(length(clusters))
turbo_palette <- setNames(turbo_colors, clusters)
expression_plot <- ggplot(plot_data_bulk, aes(x = Cluster, y = Expression, fill = Cluster)) +
  geom_boxplot(outlier.shape = NA, width = 0.75, alpha = 0.8) +
  geom_jitter(size = 0.25, width = 0.2, alpha = 0.5) +
  facet_wrap(~Gene, scales = "free", ncol = 2) +
  theme_minimal() +
  labs(y = "Normalized Expression", x = NULL) +
  theme(
    plot.title = element_blank(),
    axis.title = element_text(color = "black", size = 10, face = "bold"),
    axis.text.y = element_text(color = "black", size = 10),
    axis.text.x = element_text(color = "black", size = 10, angle = 45, hjust = 1),
    strip.text = element_text(color = "black", size = 10, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    legend.position = "none"
  ) +
  scale_fill_manual(values = turbo_palette)
ggsave(file.path(figdir, "TOX_TCF7_Bulk_Expr.png"), expression_plot, width =5, height = 2.5, dpi = 300, bg = "white")
ggsave(file.path(figdir, "TOX_TCF7_Bulk_Expr.pdf"), expression_plot, width = 5, height = 2.5, bg = "white")

library(grid)
outdir <- file.path(figdir, "heatmaps_by_set")
dir.create(outdir, recursive = TRUE, showWarnings = FALSE)
tox_targets  <- all_model_results_final %>% filter(TOX_Acute == 1) %>% filter(!acr_id %in% NA) %>% pull(acr_gene) %>% unique()
tcf7_targets <- all_model_results_final %>% filter(TCF7_Acute == 1) %>% filter(!acr_id %in% NA) %>% pull(acr_gene) %>% unique()
acr_gene_sets <- list(TCF7 = tcf7_targets, TOX = tox_targets)
tcf7_sp <- all_model_results_final %>% filter(acr_gene %in% setdiff(acr_gene_sets$TCF7, acr_gene_sets$TOX))
tox_sp  <- all_model_results_final %>% filter(acr_gene %in% setdiff(acr_gene_sets$TOX,  acr_gene_sets$TCF7))
common  <- all_model_results_final %>% filter(acr_gene %in% intersect(acr_gene_sets$TCF7, acr_gene_sets$TOX))
sets_list <- list(
  TCF7_specific = tcf7_sp,
  TOX_specific  = tox_sp,
  Common        = common
)
n_rows_per_set <- sapply(sets_list, function(df) nrow(df %>% distinct(acr_id, gene)))
n_rows_max <- max(n_rows_per_set, 1)
coldata_df <- as.data.frame(colData(mae_paired))
if ("ATAC_ID" %in% colnames(coldata_df)) {
  final_col_order_atac <- coldata_df$ATAC_ID
} else {
  final_col_order_atac <- coldata_df$RNA_ID
}
n_cols <- length(final_col_order_atac)
cell_width <- unit(0.2, "mm")
cell_height <- unit(0.14, "mm")
total_heatmap_width  <- n_cols * cell_width
total_heatmap_height <- n_rows_max * cell_height
total_width_mm  <- as.numeric(convertUnit(total_heatmap_width, "mm"))
total_height_mm <- as.numeric(convertUnit(total_heatmap_height, "mm"))
for (set_name in names(sets_list)) {
  message("Processing set: ", set_name)
  filtered_data_tox <- sets_list[[set_name]]
  if (nrow(filtered_data_tox) == 0) {
    message("  Skipping empty set: ", set_name)
    next
  }
  atac_mat <- assay(mae_paired[["atac"]])
  rna_mat  <- assay(mae_paired[["rna"]])
  rownames(rna_mat) <- rowData(mae_paired[["rna"]])$geneSymbol
  rna_mat <- rna_mat[!duplicated(rownames(rna_mat)), ]
  atac_mat_sub <- atac_mat[filtered_data_tox$acr_id, , drop = FALSE]
  rna_mat_sub  <- rna_mat[filtered_data_tox$gene, , drop = FALSE]
  row_zscores <- function(mat, limits = c(-2, 2)) {
    z <- t(scale(t(mat)))
    z[z > limits[2]] <- limits[2]
    z[z < limits[1]] <- limits[1]
    return(z)
  }
  atac_z <- row_zscores(atac_mat_sub)
  rna_z  <- row_zscores(rna_mat_sub)
  cell_subset_order <- c("Naive", "SCM-R3-", "SCM-R3+", "CM", "EM1", "EM2", "EMRA", "PD1+CD39+")
  coldata_df <- as.data.frame(colData(mae_paired)) %>%
    dplyr::mutate(Cell_Subset = factor(Cell_Subset, levels = cell_subset_order)) %>%
    filter(!is.na(Cell_Subset))
  cluster_colors <- viridis::turbo(length(cell_subset_order))
  cluster_color_mapping <- setNames(cluster_colors, cell_subset_order)
  ordered_cols_df <- coldata_df %>%
    arrange(factor(Cell_Subset, levels = cell_subset_order))
  atac_z_ordered <- atac_z[, ordered_cols_df$ATAC_ID, drop = FALSE]
  rna_z_ordered  <- rna_z[, ordered_cols_df$RNA_ID,  drop = FALSE]
  set.seed(1)
  k <- 3
  km_result_cols <- kmeans(t(rna_z_ordered), centers = k, nstart = 50)
  try({
    named_idxs <- c("R_S7007", "R_S7006", "R_S8023")
    if (all(named_idxs %in% names(km_result_cols$cluster))) {
      km_result_cols$cluster <- factor(km_result_cols$cluster, levels = c(
        km_result_cols$cluster["R_S7007"],
        km_result_cols$cluster["R_S7006"],
        km_result_cols$cluster["R_S8023"]
      ))
    } else {
      km_result_cols$cluster <- factor(km_result_cols$cluster)
    }
  }, silent = TRUE)
  col_cluster_df <- data.frame(
    ATAC_ID = colnames(atac_z_ordered),
    cluster = km_result_cols$cluster
  ) %>%
    left_join(ordered_cols_df, by = "ATAC_ID") %>%
    arrange(cluster, Cell_Subset)
  final_col_order_atac <- col_cluster_df$ATAC_ID
  final_col_order_rna  <- col_cluster_df$RNA_ID
  column_splits <- col_cluster_df$cluster
  atac_z_col_ordered <- atac_z_ordered[, final_col_order_atac, drop = FALSE]
  rna_z_col_ordered  <- rna_z_ordered[, final_col_order_rna,  drop = FALSE]
  naive_cols <- col_cluster_df %>% filter(Cell_Subset == "Naive") %>% pull(RNA_ID)
  mean_rna_in_naive <- rowMeans(rna_z_col_ordered[, naive_cols, drop = FALSE], na.rm = TRUE)
  pd1_cols <- col_cluster_df %>% filter(Cell_Subset %in% c("EM1","EM2","EMRA", "PD1+CD39+")) %>% pull(RNA_ID)
  mean_rna_in_pd1 <- rowMeans(rna_z_col_ordered[, pd1_cols, drop = FALSE], na.rm = TRUE)
  set.seed(1)
  km_result_rows <- kmeans(rna_z_ordered, centers = 2, nstart = 50, iter.max = 1000)
  cluster_means <- tapply(mean_rna_in_naive, km_result_rows$cluster, mean)
  high_expr_cluster <- names(cluster_means)[which.max(cluster_means)]
  low_expr_cluster  <- names(cluster_means)[which.min(cluster_means)]
  p2g_with_clusters <- filtered_data_tox %>%
    dplyr::rename(
      peak_id = acr_id,
      gene_symbol = gene
    ) %>%
    dplyr::mutate(
      km_cluster_id = km_result_rows$cluster
    ) %>%
    dplyr::mutate(
      km_cluster_name = factor(
        km_cluster_id,
        levels = c(high_expr_cluster, low_expr_cluster),
        labels = c("Naive", "Effector")
      )
    )
  write.csv(
    p2g_with_clusters,
    file = file.path(outdir, paste0(set_name,"_peak_gene_pairs_bulk_rna_heatmap_genes_in_each_km_cluster.csv")),
    row.names = FALSE
  )
  rows_high <- which(km_result_rows$cluster == high_expr_cluster)
  rows_low  <- which(km_result_rows$cluster == low_expr_cluster)
  sorted_high <- rows_high[order(mean_rna_in_naive[rows_high], decreasing = TRUE)]
  sorted_low  <- rows_low[order(mean_rna_in_pd1[rows_low], decreasing = FALSE)]
  final_row_order <- c(sorted_high, sorted_low)
  atac_final_reordered <- atac_z_col_ordered[final_row_order, , drop = FALSE]
  rna_final_reordered  <- rna_z_col_ordered[final_row_order, , drop = FALSE]
  final_genes_ordered  <- p2g_with_clusters$gene_symbol[final_row_order]
  row_split_factor <- factor(
    c(rep("Naive", length(sorted_high)), rep("Effector", length(sorted_low))),
    levels = c("Naive", "Effector")
  )
  interesting_genes_list <- c(
    "PDCD1", "TNFRSF9", "TNF", "FASLG", "BHLHE40", "ARID5B", "FYN", "GZMB","KLF7","FOSL2",
    "IL2RA", "IL2RB", "IRF4", "TCF7", "FOSL1", "JUN", "BATF", "DKK3",
    "LAG3",  "KLRG1", "RUNX1", "RUNX2", "RUNX3",
      "RBPJ", "NFATC3", "NFAT5", "FAS", "PRDM1", "BACH2", "ID2",
    "ID3", "NFKB1", "FOXP1", "IL7R", "SOX4", "RELA", "FOS", "IFNG", "IKZF2", "IRF2",
    "CD28", "CTLA4", "TOX", "TOX2", "ICOS", "TIGIT", "CD69",
    "LEF1", "CCR7", "FOXO1", "STAT5A", "STAT5B", "IKZF3",
    "AHR","LAYN","KAT6A","BACH2","KAT2B","CD27",
    "KLF2","MAF","MAL","SELL","TNFRSF1B","CCR5","NFKBIZ","IL15RA"
  )
  idx_to_label <- sapply(interesting_genes_list, function(gene) {
    which_gene <- which(final_genes_ordered == gene)
    if (length(which_gene) == 0) return(NA)
    gene_means <- rowMeans(rna_final_reordered[which_gene, , drop = FALSE])
    which_gene[which.max(gene_means)]
  })
  idx_to_label <- unique(na.omit(idx_to_label))
  gene_label_annotation <- rowAnnotation(
    Labels = anno_mark(at = idx_to_label, labels = final_genes_ordered[idx_to_label], labels_gp = gpar(fontsize = 7)),
    width = unit(2, "cm")
  )
  final_col_annotation <- HeatmapAnnotation(
    `Cell Subset` = factor(col_cluster_df$Cell_Subset, levels = cell_subset_order),
    col = list(`Cell Subset` = cluster_color_mapping),
    show_annotation_name = FALSE,
    simple_anno_size = unit(0.25, "cm"),
    annotation_legend_param = list(
      title_gp  = gpar(fontsize = 7, fontface = "bold"),
      labels_gp = gpar(fontsize = 7, fontface = "plain")
    )
  )
  final_heatmap_pairs <- filtered_data_tox[final_row_order, ]
  regulation_vec <- case_when(
    final_heatmap_pairs$annotation == "Promoter" ~ "TSS-Proximal",
    final_heatmap_pairs$annotation == "Promoter_Enhancer" ~ "TSS-Proximal Enhancer",
    final_heatmap_pairs$annotation == "Enhancer" ~ "Enhancer",
    TRUE ~ NA_character_
  )
  regulation_vec <- factor(regulation_vec, levels = c("TSS-Proximal", "TSS-Proximal Enhancer", "Enhancer"))
  regulation_colors <- c(
    "TSS-Proximal" = "#FF5733",
    "TSS-Proximal Enhancer" = "#33CC33",
    "Enhancer" = "#3355FF"
  )
  km_cluster_row_colors <- c("Naive" = "lightblue", "Effector" = "navy")
  left_ha <- rowAnnotation(
    `KM Cluster` = row_split_factor,
    Site = regulation_vec,
    col = list(
      `KM Cluster` = km_cluster_row_colors,
      Site = regulation_colors
    ),
    annotation_name_side = "top",
    annotation_name_gp = gpar(fontsize = 7),
    simple_anno_size = unit(2, "mm"),
    annotation_legend_param = list(
      `KM Cluster` = list(
        title_gp = gpar(fontsize = 7, fontface = "bold"),
        labels_gp = gpar(fontsize = 7)
      ),
      Site = list(
        title_gp = gpar(fontsize = 7, fontface = "bold"),
        labels_gp = gpar(fontsize = 7)
      )
    )
  )
  pal_atac <- paletteContinuous("blueYellow")
  pal_rna  <- paletteContinuous("horizonExtra")
  color_fun_atac <- colorRamp2(seq(-2, 2, length.out = length(pal_atac)), pal_atac)
  color_fun_rna <- colorRamp2(seq(-2, 2, length.out = length(pal_rna)), pal_rna)
  total_heatmap_width  <- total_heatmap_width
  total_heatmap_height <- total_heatmap_height
  expected_pairs <- filtered_data_tox[final_row_order, ]
  stopifnot(rownames(atac_final_reordered) == expected_pairs$acr_id)
  stopifnot(rownames(rna_final_reordered) == expected_pairs$gene)
  ht_atac <- Heatmap(
    atac_final_reordered,
    name = "ATAC Z-Score",
    col = color_fun_atac,
    top_annotation = final_col_annotation,
    width = total_heatmap_width,
    height = total_heatmap_height,
    left_annotation = left_ha,
    cluster_columns = FALSE,
    cluster_rows = TRUE,
    show_row_dend = FALSE,
    row_dend_reorder = TRUE,
    cluster_row_slices = FALSE,
    show_row_names = FALSE,
    show_column_names = FALSE,
    column_title_gp = gpar(fontsize = 8, fontface = "bold"),
    row_title_gp = gpar(fontsize = 8, fontface = "bold"),
    column_split = column_splits,
    row_split = row_split_factor,
    column_title = "ATAC Peak Signal",
    border = TRUE,
    row_dend_side = "left",
    use_raster = TRUE,
    raster_quality = 10,
    heatmap_legend_param = list(title = "ATAC Z-score", title_gp = gpar(fontsize = 7, fontface = "bold"), labels_gp = gpar(fontsize = 7))
  )
  ht_rna <- Heatmap(
    rna_final_reordered,
    name = "RNA Z-Score",
    col = color_fun_rna,
    right_annotation = gene_label_annotation,
    top_annotation = final_col_annotation,
    cluster_columns = FALSE,
    width = total_heatmap_width,
    height = total_heatmap_height,
    cluster_rows = FALSE,
    show_row_names = FALSE,
    show_column_names = FALSE,
    column_title_gp = gpar(fontsize = 8, fontface = "bold"),
    row_title_gp = gpar(fontsize = 8, fontface = "bold"),
    column_split = column_splits,
    row_title = NULL,
    column_title = "RNA Gene Expr",
    border = TRUE,
    use_raster = TRUE,
    raster_quality = 10,
    heatmap_legend_param = list(title = "RNA Z-score", title_gp = gpar(fontsize = 7, fontface = "bold"), labels_gp = gpar(fontsize = 7))
  )
  png(file.path(outdir, paste0("peak_gene_links_matched_heatmap_", set_name, ".png")),
      width = 5, height = 6.5, units = "in", res = 300)
  ComplexHeatmap::draw(ht_atac + ht_rna,
       heatmap_legend_side = "right",
       annotation_legend_side = "right",
       ht_gap                 = unit(0.05, "mm"),
       legend_gap             = unit(0.5, "mm"),
       merge_legend = TRUE)
  dev.off()
  pdf(file.path(outdir, paste0("peak_gene_links_matched_heatmap_", set_name, ".pdf")),
      width = 10, height = 10) 
  ComplexHeatmap::draw(ht_atac + ht_rna,
       heatmap_legend_side = "right",
       annotation_legend_side = "right",
       ht_gap                 = unit(0.05, "mm"),
       legend_gap             = unit(0.5, "mm"),
       merge_legend = TRUE)
  dev.off()
  message("Saved heatmaps for set: ", set_name)
}

# ----------------------------------------
# Permutation and Fisher test for TOX and TCF7 binding at enhancer regions
# ----------------------------------------

final_annotated_results <- read.csv( file = file.path(figdir,"ALL_ACUTE_AND_CHRONIC_final_annotated_results_from_acr_gene_pairs_for_modeling.csv"))
all_model_results_final <- read.csv(file = file.path(figdir,"ALL_ACUTE_AND_CHRONIC_FILTERED_final_annotated_results_from_acr_gene_pairs_for_modeling.csv"))

enhancer_counts_before_filtering <- final_annotated_results %>%
  distinct(acr_id, .keep_all = TRUE) %>%
  filter(is_enhancer == TRUE) %>%
  select(all_of(tf_groups)) %>%
  summarise_all(~sum(., na.rm = TRUE)) %>%
  pivot_longer(cols = everything(), names_to = "Transcription_Factor", values_to = "Enhancer_Region_Count") %>%
  arrange(desc(Enhancer_Region_Count))
cat("--- TF Counts in Enhancer Regions (Before Filtering) ---\n")
print(enhancer_counts_before_filtering)

enhancer_counts_after_filtering <- all_model_results_final %>%
  distinct(acr_id, .keep_all = TRUE) %>%
  filter(is_enhancer == TRUE) %>%
  select(all_of(tf_groups)) %>%
  summarise_all(~sum(., na.rm = TRUE)) %>%
  pivot_longer(cols = everything(), names_to = "Transcription_Factor", values_to = "Enhancer_Region_Count") %>%
  arrange(desc(Enhancer_Region_Count))
cat("\n--- TF Counts in Enhancer Regions (After Filtering) ---\n")
print(enhancer_counts_after_filtering)

binding_summary <- final_annotated_results %>%
  mutate(bound_by_TOX = (TOX_Acute == 1),
         bound_by_TCF7 = (TCF7_Acute == 1),
         acr_gene = paste0(acr_id, "_x_", gene))

count_both_tox_tcf7 <- binding_summary %>%
  filter(bound_by_TOX & bound_by_TCF7) %>%
  summarise(unique_acr_count = n_distinct(acr_gene)) %>%
  pull(unique_acr_count)
count_only_tox <- binding_summary %>%
  filter(bound_by_TOX & !bound_by_TCF7) %>%
  summarise(unique_acr_count = n_distinct(acr_gene)) %>%
  pull(unique_acr_count)
count_only_tcf7 <- binding_summary %>%
  filter(!bound_by_TOX & bound_by_TCF7) %>%
  summarise(unique_acr_count = n_distinct(acr_gene)) %>%
  pull(unique_acr_count)
cat("--- Summary of Unique ACRs Bound by TOX and TCF7 ---\n")
cat("Total unique ACRs bound by BOTH TOX and TCF7:", count_both_tox_tcf7, "\n")
cat("Total unique ACRs bound ONLY by TOX:", count_only_tox, "\n")
cat("Total unique ACRs bound ONLY by TCF7:", count_only_tcf7, "\n")

count_either_tox_or_tcf7 <- binding_summary %>%
  filter(bound_by_TOX | bound_by_TCF7) %>%
  summarise(unique_count = n_distinct(acr_id)) %>%
  pull(unique_count)
cat("--- Summary of Unique ACR-Gene Pairs ---\n")
cat("Total unique pairs bound by EITHER TOX or TCF7:", count_either_tox_or_tcf7, "\n")
verification_total <- count_only_tox + count_only_tcf7 + count_both_tox_tcf7
cat("Verification by summing previous counts:", verification_total, "\n")

binding_summary <- all_model_results_final %>%
  mutate(bound_by_TOX = (TOX_Acute == 1),
         bound_by_TCF7 = (TCF7_Acute == 1),
         acr_gene = paste0(acr_id, "_x_", gene))
count_both_tox_tcf7 <- binding_summary %>%
  filter(bound_by_TOX & bound_by_TCF7) %>%
  summarise(unique_acr_count = n_distinct(paste0(acr_id))) %>%
  pull(unique_acr_count)
count_only_tox <- binding_summary %>%
  filter(bound_by_TOX & !bound_by_TCF7) %>%
  summarise(unique_acr_count = n_distinct(acr_id)) %>%
  pull(unique_acr_count)
count_only_tcf7 <- binding_summary %>%
  filter(!bound_by_TOX & bound_by_TCF7) %>%
  summarise(unique_acr_count = n_distinct(acr_id)) %>%
  pull(unique_acr_count)
cat("--- Summary of Unique ACRs Bound by TOX and TCF7 ---\n")
cat("Total unique ACRs bound by BOTH TOX and TCF7:", count_both_tox_tcf7, "\n")
cat("Total unique ACRs bound ONLY by TOX:", count_only_tox, "\n")
cat("Total unique ACRs bound ONLY by TCF7:", count_only_tcf7, "\n")

count_either_tox_or_tcf7 <- binding_summary %>%
  filter(bound_by_TOX | bound_by_TCF7) %>%
  summarise(unique_count = n_distinct(acr_id)) %>%
  pull(unique_count)
cat("--- Summary of Unique ACR-Gene Pairs ---\n")
cat("Total unique pairs bound by EITHER TOX or TCF7:", count_either_tox_or_tcf7, "\n")
verification_total <- count_only_tox + count_only_tcf7 + count_both_tox_tcf7
cat("Verification by summing previous counts:", verification_total, "\n")

acr_annot <- fread(file.path(bulk_atac_dir, "all_acrs_HOMER_annotated.txt")) %>%
  rename_with(~ gsub(" ", "_", .)) %>%
  mutate(acr_id = paste0(Chr, "_", Start, "_", End)) %>%
  select(acr_id, Chr, Start, End) %>%
  distinct()
all_acrs_gr <- makeGRangesFromDataFrame(acr_annot,
                                        seqnames.field = "Chr",
                                        start.field = "Start",
                                        end.field = "End")

tf_groups <- c("TOX_Acute", "TCF7_Acute")
tf_peaks_gr_list <- lapply(tf_groups, function(tf) {
  peaks_df <- annot %>%
    filter(group == tf) %>%
    tidyr::separate(peak_id, into = c("chr", "start", "end"), sep = "[_:-]", convert = TRUE)
  makeGRangesFromDataFrame(peaks_df, keep.extra.columns = TRUE)
})
names(tf_peaks_gr_list) <- tf_groups

enhancer_acrs_df <- binding_summary %>%
  distinct(acr_id, .keep_all = TRUE) %>%
  filter(bound_by_TCF7 == TRUE)
enhancer_acrs_df <- enhancer_acrs_df %>%
  separate(acr_id, into = c("chr", "start", "end"), sep = "_", convert = TRUE)
enhancer_acrs_gr <- makeGRangesFromDataFrame(
  enhancer_acrs_df,
  seqnames.field = "chr",
  start.field = "start",
  end.field = "end",
  keep.extra.columns = TRUE
)
length(enhancer_acrs_gr)

plan(multisession, workers = 10)
n_perm <- 1000
results <- future_lapply(tf_groups, function(tf) {
  message(paste("Running permutation test for:", tf))
  tf_gr <- tf_peaks_gr_list[[tf]]
  summits <- resize(tf_gr, width = 1, fix = "center")
  pt <- overlapPermTest(
    A = summits,
    B = enhancer_acrs_gr,
    genome = "hg38",
    universe = all_acrs_gr,
    ntimes = n_perm,
    alternative = "greater",
    rand.func = randomizeRegions,
    rand.args = list(
      allow.overlaps = TRUE,
      per.chromosome = TRUE,
      mask = NULL
    ),
    verbose = TRUE
  )
  data.frame(
    TF = tf,
    observed_overlaps = pt$numOverlaps$observed,
    permuted_mean     = mean(pt$numOverlaps$permuted),
    z_score           = pt$numOverlaps$zscore,
    p_value           = pt$numOverlaps$pval
  )
})
results_df <- bind_rows(results)
print(results_df)

mcols(enhancer_acrs_gr)$acr_gene <- enhancer_acrs_df$acr_gene
tox_hits <- findOverlaps(tf_peaks_gr_list[["TOX_Acute"]], enhancer_acrs_gr)
tcf7_hits <- findOverlaps(tf_peaks_gr_list[["TCF7_Acute"]], enhancer_acrs_gr)
tox_enhancer_acr_genes <- unique(mcols(enhancer_acrs_gr)$acr_gene[subjectHits(tox_hits)])
tcf7_enhancer_acr_genes <- unique(mcols(enhancer_acrs_gr)$acr_gene[subjectHits(tcf7_hits)])
length(tox_enhancer_acr_genes)
length(tcf7_enhancer_acr_genes)
tox_bound <- tox_enhancer_acr_genes
tcf7_bound <- tcf7_enhancer_acr_genes
tox_set <- unique(tox_bound)
tcf7_set <- unique(tcf7_bound)
both_bound <- intersect(tox_set, tcf7_set)
tox_only   <- setdiff(tox_set, both_bound)
tcf7_only  <- setdiff(tcf7_set, both_bound)

k_tox_total <- length(tox_set)
m_tcf7_total <- length(tcf7_set)
x_both <- length(both_bound)
total_enhancers <- length(enhancer_acrs_gr)

a <- x_both
b <- k_tox_total - x_both
c <- m_tcf7_total - x_both
d <- total_enhancers - (a + b + c)
contingency_matrix <- matrix(c(a, c, b, d), nrow = 2)
fisher_result <- fisher.test(contingency_matrix, alternative = "greater")

colnames(contingency_matrix) <- c("TCF7_Bound", "Not_TCF7_Bound")
rownames(contingency_matrix) <- c("TOX_Bound", "Not_TOX_Bound")
print("Contingency Table:")
print(contingency_matrix)
print(fisher_result)
cat("\n--- Set Counts ---\n")
cat("TOX only:", length(tox_only), "\n")
cat("TCF7 only:", length(tcf7_only), "\n")
cat("Both (Intersection):", x_both, "\n")
cat("Total bound by either (Union):", length(union(tox_set, tcf7_set)), "\n")
cat("Total enhancers in background set (N):", total_enhancers, "\n")
