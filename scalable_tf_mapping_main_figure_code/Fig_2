# Figure 2
# October 03, 2025
# Description: Peak analysis, motif enrichment, pathway analysis, genomic annotation, and permutation analysis of promoter-localized TF peaks.

suppressPackageStartupMessages({
  library(scales)
  library(future)
  library(progress)
  library(progressr)
  library(ChIPseeker)
  library(readr)
  library(data.table)
  library(purrr)
  library(stringr)
  library(tibble)
  library(ArchR)
  library(dplyr)
  library(future.apply)
  library(broom)
  library(Matrix)
  library(tidyverse)
  library(GenomicRanges)
  library(TxDb.Hsapiens.UCSC.hg38.knownGene)
  library(org.Hs.eg.db)
  library(patchwork)
  library(DESeq2)
  library(parallel)
  library(ComplexHeatmap)
  library(tidytext)
  library(RColorBrewer)
  library(circlize)
  library(viridis)
  library(janitor)
  library(R.utils)
  library(annotatr)
  library(tidyr)
  library(AnnotationHub)
  library(GenomicFeatures)
  library(EnhancedVolcano)
  library(biomaRt)
  library(pathview)
  library(ggplot2)
  library(GSVA)
  library(forcats)
  library(enrichplot)
  library(clusterProfiler)
  library(ReactomePA)
  library(DOSE)
  library(AUCell)
  library(scCustomize)
  library(gridExtra)
  library(GENIE3)
  library(ggpubr)
  library(fgsea)
  library(msigdbr)
  library(qs)
  library(UpSetR)
  library(doRNG)
  library(sctransform)
  library(rlang)
  library(cli)
  library(ggraph)
  library(ggthemes)
  library(magrittr)
  library(tictoc)
  library(rstatix)
  library(cowplot)
  library(harmony)
  library(rhdf5)
  library(Seurat)
  library(SeuratObject)
  options(Seurat.object.assay.version = "v5")
  options(future.globals.maxSize = 1e9)
})

input_dir <- Sys.getenv("PEAK_ANALYSIS_INPUT_DIR", unset = "./input")
output_dir <- Sys.getenv("PEAK_ANALYSIS_OUTPUT_DIR", unset = "./output")
figdir <- file.path(output_dir, "figures")
dir.create(figdir, recursive = TRUE, showWarnings = FALSE)

ac_file <- file.path(input_dir, "HOMER_annotations_COMBINED_all_Group_vs_Control_results_acute.csv")
ch_file <- file.path(input_dir, "HOMER_annotations_COMBINED_all_Group_vs_Control_results_chronic.csv")

acute_color <- "#0E8746"
chronic_color <- "#00007F"

ac <- read.csv(ac_file)
ch <- read.csv(ch_file)
comb <- rbind(ac, ch)

counts <- comb %>% group_by(group) %>% dplyr::count() %>%
  dplyr::mutate(
    TF = recode(group,
      "SOX4_Acute" = "SOX4 Acute",
      "SOX4_Chronic" = "SOX4 Chronic",
      "TCF7_Acute" = "TCF7 Acute",
      "TCF7_Chronic" = "TCF7 Chronic",
      "TOX_Acute" = "TOX Acute",
      "TOX_Chronic" = "TOX Chronic",
      "TOX2_Acute" = "TOX2 Acute",
      "TOX2_Chronic" = "TOX2 Chronic",
      "RBPJ_Acute" = "RBPJ Acute"
    ),
    TF = factor(TF, levels = c(
      "TOX Acute", "TOX2 Acute", "TCF7 Acute", "SOX4 Acute", "RBPJ Acute",
      "TOX Chronic", "TOX2 Chronic", "TCF7 Chronic", "SOX4 Chronic"
    ))
  )

color_mapping <- setNames(
  ifelse(grepl("Acute", levels(counts$TF)), acute_color, chronic_color),
  levels(counts$TF)
)

p <- ggplot(counts, aes(x = TF, y = n, fill = TF)) +
  geom_bar(stat = "identity", color = "black", width = 0.5, linewidth = 0.25) +
  scale_fill_manual(values = color_mapping) +
  labs(x = NULL, y = "Peak Count") +
  theme_minimal(base_size = 8) +
  theme(
    text = element_text(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.line = element_line(color = "black", size = 0.5),
    axis.ticks = element_line(color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    legend.position = "none"
  ) + scale_y_continuous(expand = c(0, 0))

ggsave(file = file.path(figdir, "Total_Peaks_per_Condition_Plot.png"), plot = p, width = 3, height = 2.5, bg = "white", dpi = 300)
ggsave(file = file.path(figdir, "Total_Peaks_per_Condition_Plot.pdf"), plot = p, width = 3, height = 2.5)

homer_dirs <- list.files(file.path(input_dir, "HOMER/HOMER_motif_analysis"), full.names = TRUE, recursive = TRUE)
motif_result_files <- list.files(homer_dirs, pattern = "knownResults.txt", full.names = TRUE)

motif_results <- purrr::map_dfr(motif_result_files, function(file) {
  read_tsv(file, comment = "#", show_col_types = FALSE, col_names = TRUE) %>%
    janitor::clean_names() %>%
    dplyr::mutate(group_name = basename(dirname(file)) %>%
      str_remove("_motif_output$") %>%
      str_trim())
})

motif_results <- motif_results %>%
  dplyr::mutate(
    x6_split = str_split(x6, pattern = "\t"),
    pct_target = map_dbl(x6_split, ~ as.numeric(str_remove(.[2], "%"))),
    pct_background = map_dbl(x6_split, ~ as.numeric(str_remove(.[4], "%")))
  ) %>%
  select(-x6, -x6_split)

groups_of_interest <- c("TCF7", "SOX4", "RBPJ")
motif_filtered <- motif_results %>%
  filter(str_detect(group_name, paste(groups_of_interest, collapse = "|"))) %>%
  dplyr::mutate(motif_name_clean = toupper(str_extract(motif_name, "^[^/]+"))) %>%
  filter(
    (str_detect(group_name, "TCF7") & motif_name_clean == "TCF7(HMG)") |
      (str_detect(group_name, "SOX4") & motif_name_clean == "SOX4(HMG)") |
      (str_detect(group_name, "RBPJ") & motif_name_clean == "RBPJ1(?)")
  ) %>%
  filter(-log_p_value > 30)

motif_filtered <- motif_filtered %>%
  dplyr::mutate(
    group_name = recode(group_name,
      "SOX4_Acute" = "SOX4 Acute",
      "SOX4_Chronic" = "SOX4 Chronic",
      "TCF7_Acute" = "TCF7 Acute",
      "TCF7_Chronic" = "TCF7 Chronic",
      "RBPJ_Acute" = "RBPJ Acute"
    ),
    group_name = factor(group_name, levels = c("TCF7 Acute", "TCF7 Chronic", "SOX4 Acute", "SOX4 Chronic", "RBPJ Acute"))
  )

color_mapping <- setNames(
  ifelse(grepl("Acute", levels(motif_filtered$group_name)), acute_color, chronic_color),
  levels(motif_filtered$group_name)
)

motif_plot <- ggplot(motif_filtered, aes(x = group_name, y = -log_p_value, fill = group_name)) +
  geom_col(color = "black", linewidth = 0.25, width = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = color_mapping) +
  labs(x = NULL, y = "-log10(P) of TF's Motif", fill = "Group") +
  theme_minimal(base_size = 8) +
  theme(
    text = element_text(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.line = element_line(color = "black", size = 0.5),
    axis.ticks = element_line(color = "black"),
    panel.background = element_blank(),
    plot.background = element_blank(),
    legend.position = "none"
  ) + scale_y_continuous(expand = c(0, 0))

ggsave(file.path(figdir, "homer_motifs.png"), motif_plot, width = 3, height = 2.25, dpi = 300, bg = "white")
ggsave(file.path(figdir, "homer_motifs.pdf"), motif_plot, width = 3, height = 2.25)

comb_filtered <- comb %>%
  filter(
    gene_type == "protein-coding",
    str_detect(annotation, regex("promoter", ignore_case = TRUE))
  )

genes_per_group <- comb_filtered %>%
  group_by(group) %>%
  dplyr::summarise(entrez_id = list(unique(entrez_id))) %>%
  { setNames(.$entrez_id, .$group) }

go_list <- map2(genes_per_group, names(genes_per_group), function(genes, group_name) {
  res <- enrichGO(gene = genes, OrgDb = org.Hs.eg.db, ont = "BP", pAdjustMethod = "BH", pvalueCutoff = 0.05, qvalueCutoff = 0.05, readable = TRUE)
  if (length(res@result) == 0) return(NULL)
  res@result$group <- group_name
  res
})

all_res <- bind_rows(lapply(go_list, function(x) x@result))

select_top_unique_pathways <- function(df, top_n = 3, max_jaccard = 0.8) {
  selected <- list()
  selected_indices <- integer()
  gene_lists <- str_split(df$geneID, pattern = "/|,|;")
  for (i in seq_len(nrow(df))) {
    current_genes <- gene_lists[[i]]
    if (length(selected) == 0) {
      selected <- list(current_genes)
      selected_indices <- c(selected_indices, i)
    } else {
      sims <- map_dbl(selected, ~ length(intersect(current_genes, .x)) / length(union(current_genes, .x)))
      if (all(sims < max_jaccard)) {
        selected <- append(selected, list(current_genes))
        selected_indices <- c(selected_indices, i)
      }
    }
    if (length(selected) == top_n) break
  }
  df[selected_indices, ]
}

top_clusters <- all_res %>%
  filter(qvalue < 0.05) %>%
  group_by(group) %>%
  arrange(qvalue) %>%
  group_split() %>%
  map_dfr(~ select_top_unique_pathways(.x, top_n = 3, max_jaccard = 0.8)) %>%
  dplyr::mutate(neg_log_fdr = -log10(qvalue))

desc_recode <- c(
  "telomere organization" = "Telomere",
  "protein localization to chromosome" = "Chromosome Localization",
  "lymphocyte differentiation" = "Lymphocyte Diff",
  "nucleosome organization" = "Nucleosome Organization",
  "alpha-beta T cell activation" = "T Cell Act.",
  "epigenetic regulation of gene expression" = "Epigenetic Reg.",
  "positive regulation of interleukin-12 production" = "IL12 Production",
  "natural killer cell mediated immunity" = "NK Immunity",
  "regulation of hemopoiesis" = "Hemopoiesis",
  "lymphocyte proliferation" = "Lymphocyte Proliferation",
  "positive regulation of cell activation" = "Cell Act.",
  "CD4-positive, alpha-beta T cell activation" = "CD4 T Cell Act.",
  "regulation of mononuclear cell migration" = "Migration",
  "myeloid cell differentiation" = "Myeloid Diff.",
  "mononuclear cell proliferation" = "Mononuclear Prolif.",
  "regulation of lymphocyte differentiation" = "Reg. of Lymphocyte Diff.",
  "nucleosome assembly" = "Nucleosome Assembly",
  "regulation of alpha-beta T cell activation" = "Reg. of αβ T Cell Act.",
  "homeostasis of number of cells" = "Cell Cycle",
  "T cell differentiation" = "T Cell Diff",
  "positive regulation of leukocyte activation" = "Leukocyte Act.",
  "T cell selection" = "T Cell Selection",
  "regulation of T cell activation" = "Reg. of T Cell Act.",
  "regulation of T cell differentiation" = "Reg. of T Cell Diff.",
  "positive regulation of mononuclear cell proliferation" = "Proliferation",
  "CD4-positive, alpha-beta T cell differentiation involved in immune response" = "CD4 T Cell Diff."
)

top_clusters <- top_clusters %>%
  dplyr::mutate(
    Description = recode(as.character(Description), !!!desc_recode)
  )

top_clusters$group <- factor(top_clusters$group, levels = c(
  "TOX_Acute", "TOX_Chronic", "TOX2_Acute", "TOX2_Chronic",
  "TCF7_Acute", "TCF7_Chronic", "SOX4_Acute", "SOX4_Chronic", "RBPJ_Acute"
))

top_clusters <- top_clusters %>%
  group_by(group) %>%
  arrange(desc(Count), .by_group = TRUE) %>%
  dplyr::mutate(Description = factor(Description, levels = unique(Description))) %>%
  ungroup()

dot_plot <- ggplot(top_clusters, aes(x = group, y = Description, size = Count, color = neg_log_fdr)) +
  geom_point(alpha = 1) +
  geom_point(shape = 1, colour = "black", stroke = 0.3, show.legend = FALSE) +
  scale_color_viridis(name = "-log10(FDR)", option = "B", direction = 1, limits = c(0, 10), oob = scales::squish) +
  scale_size_continuous(name = "Gene Count", range = c(1, 4), limits = c(0, 40)) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8, face = "bold", color = "black"),
    axis.text.y = element_text(size = 8, color = "black"),
    axis.ticks = element_line(color = "black"),
    legend.position = "right",
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    strip.text = element_text(size = 8, color = "black"),
    strip.background = element_blank()
  ) +
  scale_y_discrete(limits = rev)

ggsave(file.path(figdir, "Top_Unique_GO_Promoter_Enriched_Terms_HOMER_Promoter_Protein_Coding.png"),
       dot_plot, width = 4, height = 3.5, bg = "white", dpi = 300)
ggsave(file.path(figdir, "Top_Unique_GO_Promoter_Enriched_Terms_HOMER_Promoter_Protein_Coding.pdf"),
       dot_plot, width = 4, height = 3.4)

comb <- comb %>%
  dplyr::mutate(
    annot_type_simple = case_when(
      abs(distance_to_tss) <= 1000 ~ "Promoter",
      abs(distance_to_tss) > 1000 & abs(distance_to_tss) <= 5000 ~ "+/-5kb of TSS",
      grepl("3' UTR", annotation, ignore.case = TRUE) ~ "3' UTR",
      grepl("5' UTR", annotation, ignore.case = TRUE) ~ "5' UTR",
      grepl("exon", annotation, ignore.case = TRUE) ~ "Exon",
      grepl("intron", annotation, ignore.case = TRUE) ~ "Intron",
      grepl("Intergenic", annotation, ignore.case = TRUE) ~ "Intergenic",
      grepl("non-coding", annotation, ignore.case = TRUE) ~ "Intergenic",
      grepl("TTS", annotation, ignore.case = TRUE) ~ "TTS",
      TRUE ~ "Other"
    )
  )

label_order <- c("Promoter", "+/-5kb of TSS", "5' UTR", "Exon", "Intron", "3' UTR", "TTS", "Intergenic")
group_order <- c("TOX_Acute", "TOX_Chronic", "TOX2_Acute", "TOX2_Chronic", "TCF7_Acute", "TCF7_Chronic", "SOX4_Acute", "SOX4_Chronic", "RBPJ_Acute")

prop_df <- comb %>%
  group_by(group, annot_type_simple) %>%
  dplyr::summarise(count = n(), .groups = "drop") %>%
  group_by(group) %>%
  dplyr::mutate(proportion = count / sum(count)) %>%
  ungroup() %>%
  dplyr::mutate(
    annot_type_simple = factor(annot_type_simple, levels = rev(label_order)),
    group = factor(group, levels = rev(group_order))
  )

plot_colors <- RColorBrewer::brewer.pal(n = length(levels(prop_df$annot_type_simple)), name = "Paired")

genomic_distribution_plot <- ggplot(prop_df, aes(x = group, y = proportion, fill = annot_type_simple)) +
  geom_col(color = "black", linewidth = 0.25, width = 0.5) +
  scale_fill_manual(values = plot_colors, name = "Genomic Region", drop = FALSE, guide = guide_legend(reverse = TRUE)) +
  coord_flip() +
  labs(x = NULL, y = "Proportion of Peaks") +
  theme_minimal(base_size = 8) +
  theme(
    axis.title.y = element_text(color = "black", size = 8, face = "bold"),
    axis.text.x = element_text(color = "black", size = 8, face = "bold"),
    axis.text.y = element_text(color = "black", size = 8, face = "bold"),
    legend.title = element_text(color = "black", size = 7, face = "bold"),
    legend.text = element_text(color = "black", size = 7),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    panel.grid.major = element_blank(),
    axis.line = element_line(color = "black", size = 0.5),
    plot.title = element_text(hjust = 0.5, face = "bold", color = "black", size = 8)
  )

ggsave(file.path(figdir, "HOMER_genomic_annotation_proportions_plot_accent.png"),
       genomic_distribution_plot, width = 3.25, height = 2.5, dpi = 300, bg = "white")
ggsave(file.path(figdir, "HOMER_genomic_annotation_proportions_plot_accent.pdf"),
       genomic_distribution_plot, width = 3.25, height = 2.5, bg = "white")

# ---- Overlap logic ----
all_peaks_clean_plot <- comb %>%
  filter(group %in% c(
    "SOX4_Acute", "SOX4_Chronic",
    "TCF7_Acute", "TCF7_Chronic",
    "TOX_Acute", "TOX_Chronic",
    "TOX2_Acute", "TOX2_Chronic",
    "RBPJ_Acute"
  ))

acr_annot_file <- file.path(input_dir, "acr_annot.csv")
acr_annot <- read.csv(acr_annot_file)

peaks_gr <- GRanges(
  seqnames = all_peaks_clean_plot$chr,
  ranges   = IRanges(start = all_peaks_clean_plot$start, end = all_peaks_clean_plot$end),
  peak_id  = all_peaks_clean_plot$peak_id,
  group    = all_peaks_clean_plot$group
)

acr_gr <- GRanges(
  seqnames = acr_annot$Chr,
  ranges   = IRanges(start = acr_annot$Start, end = acr_annot$End),
  acr_id   = acr_annot$acr_id
)

hits <- findOverlaps(peaks_gr, acr_gr, maxgap = 1000)

all_peaks_clean_plot$overlaps_acr <- FALSE
all_peaks_clean_plot$overlaps_acr[queryHits(hits)] <- TRUE

counts_overlap <- all_peaks_clean_plot %>%
  group_by(group) %>%
  summarise(
    overlap = sum(overlaps_acr),
    nonoverlap = n() - sum(overlaps_acr),
    .groups = "drop"
  ) %>%
  mutate(
    TF = recode(
      group,
      "SOX4_Acute"   = "SOX4 Acute",
      "SOX4_Chronic" = "SOX4 Chronic",
      "TCF7_Acute"   = "TCF7 Acute",
      "TCF7_Chronic" = "TCF7 Chronic",
      "TOX_Acute"    = "TOX Acute",
      "TOX_Chronic"  = "TOX Chronic",
      "TOX2_Acute"   = "TOX2 Acute",
      "TOX2_Chronic" = "TOX2 Chronic",
      "RBPJ_Acute"   = "RBPJ Acute"
    ),
    TF = factor(TF, levels = c("TOX Acute", "TOX2 Acute", "TCF7 Acute", "SOX4 Acute", "RBPJ Acute",
                               "TOX Chronic", "TOX2 Chronic", "TCF7 Chronic", "SOX4 Chronic"))
  )

counts_long <- counts_overlap %>%
  pivot_longer(cols = c("overlap", "nonoverlap"), names_to = "status", values_to = "count")

base_colors <- setNames(
  ifelse(grepl("Acute", levels(counts_overlap$TF)), acute_color, chronic_color),
  levels(counts_overlap$TF)
)

color_mapping <- c()
for (tf in names(base_colors)) {
  base_col <- base_colors[tf]
  color_mapping[paste0(tf, "_overlap")]    <- base_col
  color_mapping[paste0(tf, "_nonoverlap")] <- scales::alpha(base_col, 0.2)
}

p <- ggplot(counts_long, aes(x = TF, y = count, fill = interaction(TF, status, sep = "_"))) +
  geom_bar(stat = "identity", color = "black", width = 0.5, linewidth = 0.25) +
  scale_fill_manual(values = color_mapping, guide = "none") +
  labs(x = NULL, y = "Peak Count") + 
  theme_minimal(base_size = 8) +
  theme(
    text = element_text(color = "black"),
    axis.title.y = element_text(face = "bold"),
    axis.text = element_text(face = "bold", color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.line = element_line(color = "black", size = 0.5),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    legend.position = "none"
  ) +
  scale_y_continuous(expand = c(0, 0))

ggsave(file = file.path(figdir, "Peaks_per_Condition_Color_by_Peak_Overlap_with_ATACseq.png"), plot = p, width = 3, height = 2.5, bg = "white", dpi = 300)
ggsave(file = file.path(figdir, "Peaks_per_Condition_Color_by_Peak_Overlap_with_ATACseq.pdf"), plot = p, width = 3, height = 2.5)

# ---- Log2fc violin Plot ----
all_peaks_clean_plot <- all_peaks_clean_plot %>%
  mutate(
    TF = recode(
      group,
      "SOX4_Acute"   = "SOX4 Acute",
      "SOX4_Chronic" = "SOX4 Chronic",
      "TCF7_Acute"   = "TCF7 Acute",
      "TCF7_Chronic" = "TCF7 Chronic",
      "TOX_Acute"    = "TOX Acute",
      "TOX_Chronic"  = "TOX Chronic",
      "TOX2_Acute"   = "TOX2 Acute",
      "TOX2_Chronic" = "TOX2 Chronic",
      "RBPJ_Acute"   = "RBPJ Acute"
    ),
    TF = factor(TF, levels = c(
      "TOX Acute", "TOX2 Acute", "TCF7 Acute", "SOX4 Acute", "RBPJ Acute",
      "TOX Chronic", "TOX2 Chronic", "TCF7 Chronic", "SOX4 Chronic"))
  )

p <- ggplot(all_peaks_clean_plot, aes(x = TF, y = log2FoldChange, fill = TF)) +
  geom_violin(alpha = 1, trim = TRUE, color = "black", linewidth = 0.25) +
  scale_fill_manual(values = c(
    "TOX Acute"   = "#0E8746", "TOX2 Acute"   = "#0E8746", "TCF7 Acute"   = "#0E8746",
    "SOX4 Acute"  = "#0E8746", "RBPJ Acute"   = "#0E8746",
    "TOX Chronic" = "#00007F", "TOX2 Chronic" = "#00007F", "TCF7 Chronic" = "#00007F",
    "SOX4 Chronic"= "#00007F"
  )) +
  scale_y_continuous(
    limits = c(0, 8),
    breaks = 0:8,
    labels = 0:8,
    expand = c(0, 0)
  ) +
  labs(x = NULL, y = "Log2FC of SRT Insertions Relative to\nUnfused HyPBase Background Control") +
  theme_minimal(base_size = 9) +
  theme(
    text = element_text(color = "black"),
    axis.title.y = element_text(face = "bold"),
    axis.text = element_text(face = "bold", color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.line = element_line(color = "black", size = 0.5),
    axis.ticks = element_line(color = "black"),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    legend.position = "none"
  )

ggsave(file.path(figdir, "Violin_log2FC_vs_SRT.png"), plot = p, width = 4, height = 3, bg = "white", dpi = 300)
ggsave(file.path(figdir, "Violin_log2FC_vs_SRT.pdf"), plot = p, width = 4, height = 3)

# ---- Permutation test ----
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
prom5kb <- promoters(txdb, upstream = 5000, downstream = 5000)
prom5kb <- reduce(prom5kb)
prom5kb <- keepStandardChromosomes(prom5kb, pruning.mode = "coarse")

peaks_all <- makeGRangesFromDataFrame(
  comb,
  seqnames.field = "chr",
  start.field    = "start",
  end.field      = "end",
  keep.extra.columns = TRUE
)
peaks_all <- keepStandardChromosomes(peaks_all, pruning.mode = "coarse")

results <- lapply(unique(peaks_all$group), function(g) {
  peaks_grp <- peaks_all[peaks_all$group == g]
  pt <- overlapPermTest(
    A = peaks_grp,
    B = prom5kb,
    ntimes = 1000,
    genome = "hg38",
    alternative = "greater"
  )
  data.frame(
    group    = g,
    observed = pt$numOverlaps$observed,
    expected = mean(pt$numOverlaps$permuted),
    zscore   = pt$numOverlaps$zscore,
    pval     = pt$numOverlaps$pval
  )
})

results_df <- do.call(rbind, results)
write.csv(results_df, file.path(figdir, "TF_promoter5kb_enrichment_results.csv"), row.names = FALSE)
