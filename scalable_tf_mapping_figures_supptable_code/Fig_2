#==================================================================================================
# R SCRIPT FOR FIGURE 2 ANALYSIS
# DATE: October 03, 2025
#
# DESCRIPTION:
# This script performs a comprehensive analysis of ChIP-seq peak data. The analysis includes:
# - Quantification and visualization of peak counts per transcription factor (TF) and condition.
# - Motif enrichment analysis using HOMER results to validate TF binding.
# - Gene Ontology (GO) enrichment analysis for genes associated with promoter-localized peaks.
# - Annotation and visualization of the genomic distribution of peaks.
# - Quantification of peak overlap with pre-defined accessible chromatin regions (ACRs).
# - Permutation testing to determine the statistical significance of peak enrichment in promoter regions.
#==================================================================================================

# --- 1. LOAD LIBRARIES ---
suppressPackageStartupMessages({
  library(tidyverse)
  library(janitor)
  library(GenomicRanges)
  library(TxDb.Hsapiens.UCSC.hg38.knownGene)
  library(org.Hs.eg.db)
  library(clusterProfiler)
  library(RColorBrewer)
  library(viridis)
  library(scales)
  library(regioneR)
})

# --- 2. DEFINE FILE PATHS AND DIRECTORIES ---
# Define input and output directories using environment variables for portability.
# If the environment variable is not set, a default local path ("./input" or "./output") is used.
input_dir <- Sys.getenv("PEAK_ANALYSIS_INPUT_DIR", unset = "./input")
output_dir <- Sys.getenv("PEAK_ANALYSIS_OUTPUT_DIR", unset = "./output")
figdir <- file.path(output_dir, "figures") # Subdirectory for saving plots
dir.create(figdir, recursive = TRUE, showWarnings = FALSE) # Create figure directory if it does not exist

# Define paths to HOMER annotation results for acute and chronic conditions.
ac_file <- file.path(input_dir, "HOMER_annotations_COMBINED_all_Group_vs_Control_results_acute.csv")
ch_file <- file.path(input_dir, "HOMER_annotations_COMBINED_all_Group_vs_Control_results_chronic.csv")

# --- 3. DEFINE COLOR PALETTE ---
# Define consistent colors for acute and chronic conditions.
acute_color <- "#0E8746"
chronic_color <- "#00007F"

# --- 4. PEAK COUNT VISUALIZATION ---
# Load and combine peak annotation data.
ac <- read.csv(ac_file)
ch <- read.csv(ch_file)
comb <- rbind(ac, ch)

# Count the number of peaks per TF group and prepare data for plotting.
counts <- comb %>%
  group_by(group) %>%
  dplyr::count() %>%
  dplyr::mutate(
    # Create a clean TF name for plotting labels.
    TF = recode(group,
      "SOX4_Acute" = "SOX4 Acute", "SOX4_Chronic" = "SOX4 Chronic",
      "TCF7_Acute" = "TCF7 Acute", "TCF7_Chronic" = "TCF7 Chronic",
      "TOX_Acute" = "TOX Acute", "TOX_Chronic" = "TOX Chronic",
      "TOX2_Acute" = "TOX2 Acute", "TOX2_Chronic" = "TOX2 Chronic",
      "RBPJ_Acute" = "RBPJ Acute"
    ),
    # Set a specific factor order for the x-axis.
    TF = factor(TF, levels = c(
      "TOX Acute", "TOX2 Acute", "TCF7 Acute", "SOX4 Acute", "RBPJ Acute",
      "TOX Chronic", "TOX2 Chronic", "TCF7 Chronic", "SOX4 Chronic"
    ))
  )

# Create a named vector to map TF levels to their respective colors.
color_mapping <- setNames(
  ifelse(grepl("Acute", levels(counts$TF)), acute_color, chronic_color),
  levels(counts$TF)
)

# Generate the bar plot for total peak counts.
p <- ggplot(counts, aes(x = TF, y = n, fill = TF)) +
  geom_bar(stat = "identity", color = "black", width = 0.5, linewidth = 0.25) +
  scale_fill_manual(values = color_mapping) +
  labs(x = NULL, y = "Peak Count") +
  theme_minimal(base_size = 8) +
  theme(
    text = element_text(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.line = element_line(color = "black", size = 0.5),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    legend.position = "none"
  ) +
  scale_y_continuous(expand = c(0, 0)) # Ensure bars start at y=0.

# Save the plot in both PNG and PDF formats.
ggsave(file.path(figdir, "Total_Peaks_per_Condition_Plot.png"), plot = p, width = 3, height = 2.5, bg = "white", dpi = 300)
ggsave(file.path(figdir, "Total_Peaks_per_Condition_Plot.pdf"), plot = p, width = 3, height = 2.5)

# --- 5. MOTIF ENRICHMENT ANALYSIS ---
# Find all HOMER known motif result files recursively.
homer_dirs <- list.files(file.path(input_dir, "HOMER/HOMER_motif_analysis"), full.names = TRUE, recursive = TRUE)
motif_result_files <- list.files(homer_dirs, pattern = "knownResults.txt", full.names = TRUE)

# Read and combine all motif result files into a single data frame.
motif_results <- purrr::map_dfr(motif_result_files, function(file) {
  read_tsv(file, comment = "#", show_col_types = FALSE, col_names = TRUE) %>%
    janitor::clean_names() %>% # Standardize column names.
    dplyr::mutate(group_name = basename(dirname(file)) %>% # Extract group name from the file path.
      str_remove("_motif_output$") %>%
      str_trim())
})

# Parse the columns containing target and background percentages.
motif_results <- motif_results %>%
  dplyr::mutate(
    x6_split = str_split(x6, pattern = "\t"),
    pct_target = map_dbl(x6_split, ~ as.numeric(str_remove(.[2], "%"))),
    pct_background = map_dbl(x6_split, ~ as.numeric(str_remove(.[4], "%")))
  ) %>%
  select(-x6, -x6_split) # Remove temporary columns.

# Filter for the enrichment of each TF's own motif.
groups_of_interest <- c("TCF7", "SOX4", "RBPJ")
motif_filtered <- motif_results %>%
  filter(str_detect(group_name, paste(groups_of_interest, collapse = "|"))) %>%
  dplyr::mutate(motif_name_clean = toupper(str_extract(motif_name, "^[^/]+"))) %>%
  filter(
    (str_detect(group_name, "TCF7") & motif_name_clean == "TCF7(HMG)") |
    (str_detect(group_name, "SOX4") & motif_name_clean == "SOX4(HMG)") |
    (str_detect(group_name, "RBPJ") & motif_name_clean == "RBPJ1(?)")
  ) %>%
  filter(-log_p_value > 30) # Apply a significance threshold.

# Prepare the filtered data for plotting with clean labels and factor levels.
motif_filtered <- motif_filtered %>%
  dplyr::mutate(
    group_name = recode(group_name,
      "SOX4_Acute" = "SOX4 Acute", "SOX4_Chronic" = "SOX4 Chronic",
      "TCF7_Acute" = "TCF7 Acute", "TCF7_Chronic" = "TCF7 Chronic",
      "RBPJ_Acute" = "RBPJ Acute"
    ),
    group_name = factor(group_name, levels = c("TCF7 Acute", "TCF7 Chronic", "SOX4 Acute", "SOX4 Chronic", "RBPJ Acute"))
  )

# Remap colors for the filtered set of TFs.
color_mapping <- setNames(
  ifelse(grepl("Acute", levels(motif_filtered$group_name)), acute_color, chronic_color),
  levels(motif_filtered$group_name)
)

# Generate the motif enrichment plot.
motif_plot <- ggplot(motif_filtered, aes(x = group_name, y = -log_p_value, fill = group_name)) +
  geom_col(color = "black", linewidth = 0.25, width = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = color_mapping) +
  labs(x = NULL, y = "-log10(P) of TF's Motif", fill = "Group") +
  theme_minimal(base_size = 8) +
  theme(
    text = element_text(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.line = element_line(color = "black", size = 0.5),
    axis.ticks = element_line(color = "black"),
    panel.background = element_blank(),
    plot.background = element_blank(),
    legend.position = "none"
  ) +
  scale_y_continuous(expand = c(0, 0))

# Save the motif plot.
ggsave(file.path(figdir, "homer_motifs.png"), motif_plot, width = 3, height = 2.25, dpi = 300, bg = "white")
ggsave(file.path(figdir, "homer_motifs.pdf"), motif_plot, width = 3, height = 2.25)

# --- 6. GENE ONTOLOGY (GO) ENRICHMENT ANALYSIS ---
# Filter peaks to include only those in promoter regions of protein-coding genes.
comb_filtered <- comb %>%
  filter(
    gene_type == "protein-coding",
    str_detect(annotation, regex("promoter", ignore_case = TRUE))
  )

# Create a named list of Entrez gene IDs for each TF group.
genes_per_group <- comb_filtered %>%
  group_by(group) %>%
  dplyr::summarise(entrez_id = list(unique(entrez_id))) %>%
  { setNames(.$entrez_id, .$group) }

# Perform GO enrichment analysis for each group using clusterProfiler.
go_list <- map2(genes_per_group, names(genes_per_group), function(genes, group_name) {
  res <- enrichGO(gene = genes, OrgDb = org.Hs.eg.db, ont = "BP", pAdjustMethod = "BH", pvalueCutoff = 0.05, qvalueCutoff = 0.05, readable = TRUE)
  if (nrow(res@result) == 0) return(NULL) # Skip if no significant terms are found.
  res@result$group <- group_name
  res
})

# Combine all GO results into a single data frame.
all_res <- bind_rows(lapply(go_list, function(x) if (!is.null(x)) x@result else NULL))

# Get top terms by qvalue
top_clusters <- all_res %>%
  filter(qvalue < 0.05) %>%
  group_by(group) %>%
  arrange(qvalue) %>%
  slice_head(n=3) %>%
  dplyr::mutate(neg_log_fdr = -log10(qvalue))

# Recode long GO term descriptions to shorter labels for plotting.
desc_recode <- c(
  "telomere organization" = "Telomere", "protein localization to chromosome" = "Chromosome Localization",
  "lymphocyte differentiation" = "Lymphocyte Diff", "nucleosome organization" = "Nucleosome Organization",
  "alpha-beta T cell activation" = "T Cell Act.", "epigenetic regulation of gene expression" = "Epigenetic Reg.",
  "positive regulation of interleukin-12 production" = "IL12 Production", "natural killer cell mediated immunity" = "NK Immunity",
  "regulation of hemopoiesis" = "Hemopoiesis", "lymphocyte proliferation" = "Lymphocyte Proliferation",
  "positive regulation of cell activation" = "Cell Act.", "CD4-positive, alpha-beta T cell activation" = "CD4 T Cell Act.",
  "regulation of mononuclear cell migration" = "Migration", "myeloid cell differentiation" = "Myeloid Diff.",
  "mononuclear cell proliferation" = "Mononuclear Prolif.", "regulation of lymphocyte differentiation" = "Reg. of Lymphocyte Diff.",
  "nucleosome assembly" = "Nucleosome Assembly", "regulation of alpha-beta T cell activation" = "Reg. of αβ T Cell Act.",
  "homeostasis of number of cells" = "Cell Cycle", "T cell differentiation" = "T Cell Diff",
  "positive regulation of leukocyte activation" = "Leukocyte Act.", "T cell selection" = "T Cell Selection",
  "regulation of T cell activation" = "Reg. of T Cell Act.", "regulation of T cell differentiation" = "Reg. of T Cell Diff.",
  "positive regulation of mononuclear cell proliferation" = "Proliferation", "CD4-positive, alpha-beta T cell differentiation involved in immune response" = "CD4 T Cell Diff."
)

top_clusters <- top_clusters %>%
  dplyr::mutate(Description = recode(as.character(Description), !!!desc_recode))

# Set factor levels for groups and descriptions to control plot order.
top_clusters$group <- factor(top_clusters$group, levels = c(
  "TOX_Acute", "TOX_Chronic", "TOX2_Acute", "TOX2_Chronic",
  "TCF7_Acute", "TCF7_Chronic", "SOX4_Acute", "SOX4_Chronic", "RBPJ_Acute"
))
top_clusters <- top_clusters %>%
  group_by(group) %>%
  arrange(desc(Count), .by_group = TRUE) %>%
  dplyr::mutate(Description = factor(Description, levels = unique(Description))) %>%
  ungroup()

# Generate the GO enrichment dot plot.
dot_plot <- ggplot(top_clusters, aes(x = group, y = Description, size = Count, color = neg_log_fdr)) +
  geom_point(alpha = 1) +
  geom_point(shape = 1, colour = "black", stroke = 0.3, show.legend = FALSE) + # Add black outline to dots.
  scale_color_viridis(name = "-log10(FDR)", option = "B", direction = 1, limits = c(0, 10), oob = scales::squish) +
  scale_size_continuous(name = "Gene Count", range = c(1, 4), limits = c(0, 40)) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8, face = "bold", color = "black"),
    axis.text.y = element_text(size = 8, color = "black"),
    axis.ticks = element_line(color = "black"),
    legend.position = "right",
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    strip.text = element_text(size = 8, color = "black"),
    strip.background = element_blank()
  ) +
  scale_y_discrete(limits = rev) # Reverse y-axis order.

# Save the dot plot.
ggsave(file.path(figdir, "Top_Unique_GO_Promoter_Enriched_Terms_HOMER_Promoter_Protein_Coding.png"),
       dot_plot, width = 4, height = 3.5, bg = "white", dpi = 300)
ggsave(file.path(figdir, "Top_Unique_GO_Promoter_Enriched_Terms_HOMER_Promoter_Protein_Coding.pdf"),
       dot_plot, width = 4, height = 3.4)

# --- 7. GENOMIC ANNOTATION DISTRIBUTION PLOT ---
# Simplify genomic annotations into broader categories.
comb <- comb %>%
  dplyr::mutate(
    annot_type_simple = case_when(
      abs(distance_to_tss) <= 1000 ~ "Promoter",
      abs(distance_to_tss) > 1000 & abs(distance_to_tss) <= 5000 ~ "+/-5kb of TSS",
      grepl("3' UTR", annotation, ignore.case = TRUE) ~ "3' UTR",
      grepl("5' UTR", annotation, ignore.case = TRUE) ~ "5' UTR",
      grepl("exon", annotation, ignore.case = TRUE) ~ "Exon",
      grepl("intron", annotation, ignore.case = TRUE) ~ "Intron",
      grepl("Intergenic", annotation, ignore.case = TRUE) ~ "Intergenic",
      grepl("non-coding", annotation, ignore.case = TRUE) ~ "Intergenic",
      grepl("TTS", annotation, ignore.case = TRUE) ~ "TTS",
      TRUE ~ "Other"
    )
  )

# Define the desired order for annotation types and TF groups.
label_order <- c("Promoter", "+/-5kb of TSS", "5' UTR", "Exon", "Intron", "3' UTR", "TTS", "Intergenic")
group_order <- c("TOX_Acute", "TOX_Chronic", "TOX2_Acute", "TOX2_Chronic", "TCF7_Acute", "TCF7_Chronic", "SOX4_Acute", "SOX4_Chronic", "RBPJ_Acute")

# Calculate the proportion of peaks in each genomic region per TF group.
prop_df <- comb %>%
  group_by(group, annot_type_simple) %>%
  dplyr::summarise(count = n(), .groups = "drop") %>%
  group_by(group) %>%
  dplyr::mutate(proportion = count / sum(count)) %>%
  ungroup() %>%
  dplyr::mutate(
    annot_type_simple = factor(annot_type_simple, levels = rev(label_order)),
    group = factor(group, levels = rev(group_order))
  )

# Define a color palette for the plot.
plot_colors <- RColorBrewer::brewer.pal(n = length(levels(prop_df$annot_type_simple)), name = "Paired")

# Generate the stacked bar plot of genomic distribution.
genomic_distribution_plot <- ggplot(prop_df, aes(x = group, y = proportion, fill = annot_type_simple)) +
  geom_col(color = "black", linewidth = 0.25, width = 0.5) +
  scale_fill_manual(values = plot_colors, name = "Genomic Region", drop = FALSE, guide = guide_legend(reverse = TRUE)) +
  coord_flip() + # Flip coordinates to make bars horizontal.
  labs(x = NULL, y = "Proportion of Peaks") +
  theme_minimal(base_size = 8) +
  theme(
    axis.title.x = element_text(color = "black", size = 8, face = "bold"),
    axis.text.y = element_text(color = "black", size = 8, face = "bold"),
    legend.title = element_text(color = "black", size = 7, face = "bold"),
    legend.text = element_text(color = "black", size = 7),
    panel.grid = element_blank(),
    legend.position = "right",
    axis.line = element_line(color = "black", size = 0.5),
    plot.title = element_text(hjust = 0.5, face = "bold", color = "black", size = 8)
  )

# Save the plot.
ggsave(file.path(figdir, "HOMER_genomic_annotation_proportions_plot_accent.png"),
       genomic_distribution_plot, width = 3.25, height = 2.5, dpi = 300, bg = "white")
ggsave(file.path(figdir, "HOMER_genomic_annotation_proportions_plot_accent.pdf"),
       genomic_distribution_plot, width = 3.25, height = 2.5, bg = "white")

# --- 8. PEAK OVERLAP WITH ACCESSIBLE CHROMATIN REGIONS (ACRs) ---
# Filter for the main TF groups to be analyzed.
all_peaks_clean_plot <- comb %>%
  filter(group %in% c(
    "SOX4_Acute", "SOX4_Chronic", "TCF7_Acute", "TCF7_Chronic",
    "TOX_Acute", "TOX_Chronic", "TOX2_Acute", "TOX2_Chronic", "RBPJ_Acute"
  ))

# Load ACR annotations.
acr_annot_file <- file.path(input_dir, "acr_annot.csv")
acr_annot <- read.csv(acr_annot_file)

# Convert peak and ACR data frames to GRanges objects for genomic interval operations.
peaks_gr <- GRanges(
  seqnames = all_peaks_clean_plot$chr,
  ranges = IRanges(start = all_peaks_clean_plot$start, end = all_peaks_clean_plot$end),
  peak_id = all_peaks_clean_plot$peak_id,
  group = all_peaks_clean_plot$group
)
acr_gr <- GRanges(
  seqnames = acr_annot$Chr,
  ranges = IRanges(start = acr_annot$Start, end = acr_annot$End),
  acr_id = acr_annot$acr_id
)

# Find overlaps between peaks and ACRs, allowing a 1kb gap.
hits <- findOverlaps(peaks_gr, acr_gr, maxgap = 1000)

# Add a logical column indicating whether each peak overlaps an ACR.
all_peaks_clean_plot$overlaps_acr <- FALSE
all_peaks_clean_plot$overlaps_acr[queryHits(hits)] <- TRUE

# Count overlapping and non-overlapping peaks for each group.
counts_overlap <- all_peaks_clean_plot %>%
  group_by(group) %>%
  summarise(
    overlap = sum(overlaps_acr),
    nonoverlap = n() - sum(overlaps_acr),
    .groups = "drop"
  ) %>%
  mutate(
    TF = recode(group,
      "SOX4_Acute" = "SOX4 Acute", "SOX4_Chronic" = "SOX4 Chronic",
      "TCF7_Acute" = "TCF7 Acute", "TCF7_Chronic" = "TCF7 Chronic",
      "TOX_Acute" = "TOX Acute", "TOX_Chronic" = "TOX Chronic",
      "TOX2_Acute" = "TOX2 Acute", "TOX2_Chronic" = "TOX2 Chronic",
      "RBPJ_Acute" = "RBPJ Acute"
    ),
    TF = factor(TF, levels = c(
      "TOX Acute", "TOX2 Acute", "TCF7 Acute", "SOX4 Acute", "RBPJ Acute",
      "TOX Chronic", "TOX2 Chronic", "TCF7 Chronic", "SOX4 Chronic"
    ))
  )

# Reshape data to long format for ggplot2.
counts_long <- counts_overlap %>%
  pivot_longer(cols = c("overlap", "nonoverlap"), names_to = "status", values_to = "count")

# Create a dynamic color mapping: solid color for overlap, transparent for non-overlap.
base_colors <- setNames(
  ifelse(grepl("Acute", levels(counts_overlap$TF)), acute_color, chronic_color),
  levels(counts_overlap$TF)
)
color_mapping_overlap <- c()
for (tf in names(base_colors)) {
  base_col <- base_colors[tf]
  color_mapping_overlap[paste0(tf, "_overlap")] <- base_col
  color_mapping_overlap[paste0(tf, "_nonoverlap")] <- scales::alpha(base_col, 0.2)
}

# Generate the overlap bar plot.
p <- ggplot(counts_long, aes(x = TF, y = count, fill = interaction(TF, status, sep = "_"))) +
  geom_bar(stat = "identity", color = "black", width = 0.5, linewidth = 0.25) +
  scale_fill_manual(values = color_mapping_overlap, guide = "none") +
  labs(x = NULL, y = "Peak Count") +
  theme_minimal(base_size = 8) +
  theme(
    text = element_text(color = "black"),
    axis.title.y = element_text(face = "bold"),
    axis.text = element_text(face = "bold", color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.line = element_line(color = "black", size = 0.5),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    legend.position = "none"
  ) +
  scale_y_continuous(expand = c(0, 0))

# Save the plot.
ggsave(file.path(figdir, "Peaks_per_Condition_Color_by_Peak_Overlap_with_ATACseq.png"), plot = p, width = 3, height = 2.5, bg = "white", dpi = 300)
ggsave(file.path(figdir, "Peaks_per_Condition_Color_by_Peak_Overlap_with_ATACseq.pdf"), plot = p, width = 3, height = 2.5)


# --- 9. LOG2 FOLD CHANGE VIOLIN PLOT ---
# Prepare data with clean TF labels and factor levels.
all_peaks_clean_plot <- all_peaks_clean_plot %>%
  mutate(
    TF = recode(group,
      "SOX4_Acute" = "SOX4 Acute", "SOX4_Chronic" = "SOX4 Chronic",
      "TCF7_Acute" = "TCF7 Acute", "TCF7_Chronic" = "TCF7 Chronic",
      "TOX_Acute" = "TOX Acute", "TOX_Chronic" = "TOX Chronic",
      "TOX2_Acute" = "TOX2 Acute", "TOX2_Chronic" = "TOX2 Chronic",
      "RBPJ_Acute" = "RBPJ Acute"
    ),
    TF = factor(TF, levels = c(
      "TOX Acute", "TOX2 Acute", "TCF7 Acute", "SOX4 Acute", "RBPJ Acute",
      "TOX Chronic", "TOX2 Chronic", "TCF7 Chronic", "SOX4 Chronic"
    ))
  )

# Create the violin plot.
p <- ggplot(all_peaks_clean_plot, aes(x = TF, y = log2FoldChange, fill = TF)) +
  geom_violin(alpha = 1, trim = TRUE, color = "black", linewidth = 0.25) +
  scale_fill_manual(values = c(
    "TOX Acute" = acute_color, "TOX2 Acute" = acute_color, "TCF7 Acute" = acute_color,
    "SOX4 Acute" = acute_color, "RBPJ Acute" = acute_color,
    "TOX Chronic" = chronic_color, "TOX2 Chronic" = chronic_color, "TCF7 Chronic" = chronic_color,
    "SOX4 Chronic" = chronic_color
  )) +
  scale_y_continuous(limits = c(0, 8), breaks = 0:8, labels = 0:8, expand = c(0, 0)) +
  labs(x = NULL, y = "Log2FC of SRT Insertions Relative to\nUnfused HyPBase Background Control") +
  theme_minimal(base_size = 9) +
  theme(
    text = element_text(color = "black"),
    axis.title.y = element_text(face = "bold"),
    axis.text = element_text(face = "bold", color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.line = element_line(color = "black", size = 0.5),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    legend.position = "none"
  )

# Save the plot.
ggsave(file.path(figdir, "Violin_log2FC_vs_SRT.png"), plot = p, width = 4, height = 3, bg = "white", dpi = 300)
ggsave(file.path(figdir, "Violin_log2FC_vs_SRT.pdf"), plot = p, width = 4, height = 3)


# --- 10. PERMUTATION TEST FOR PROMOTER ENRICHMENT ---
# Load the human gene annotation database.
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
# Define promoter regions as +/- 5kb from the Transcription Start Site (TSS).
prom5kb <- promoters(txdb, upstream = 5000, downstream = 5000)
prom5kb <- reduce(prom5kb) # Merge overlapping promoter regions.
prom5kb <- keepStandardChromosomes(prom5kb, pruning.mode = "coarse") # Keep only standard chromosomes.

# Convert the combined peak data frame to a GRanges object.
peaks_all <- makeGRangesFromDataFrame(
  comb,
  seqnames.field = "chr",
  start.field = "start",
  end.field = "end",
  keep.extra.columns = TRUE
)
peaks_all <- keepStandardChromosomes(peaks_all, pruning.mode = "coarse")

# Perform permutation test for each TF group.
results <- lapply(unique(peaks_all$group), function(g) {
  peaks_grp <- peaks_all[peaks_all$group == g]
  # Test if the number of overlaps is greater than expected by chance.
  pt <- overlapPermTest(
    A = peaks_grp,
    B = prom5kb,
    ntimes = 1000, # Number of permutations.
    genome = "hg38",
    alternative = "greater"
  )
  # Compile results into a data frame.
  data.frame(
    group = g,
    observed = pt$numOverlaps$observed,
    expected = mean(pt$numOverlaps$permuted),
    zscore = pt$numOverlaps$zscore,
    pval = pt$numOverlaps$pval
  )
})

# Combine results from all groups and save to a CSV file.
results_df <- do.call(rbind, results)
write.csv(results_df, file.path(figdir, "TF_promoter5kb_enrichment_results.csv"), row.names = FALSE)
