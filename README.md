# **Processing PAINT-seq Data to TF Binding Sites**

## **Order to run scripts**

1. ### **step_1_raw_qbed_to_insertion_maps.py**

   * **Main goal:** A comprehensive, annotation-driven script that processes raw qbed files into final SRT insertion maps for each experimental group. It performs barcode correction, annotation, fragment-based peak calling (to define regions of interest), and precise insertion site mapping.  
     * **INPUT:** Raw qbed/bed file(s) and an annotation file.  
     * **OUTPUT:** Per-sample and per-group raw and normalized insertion counts as bedgraph and bigwig files, and per-group insertion coordinates as a qbed file.

2. ### **step_2_run_span_peak_caller.sh**

   * **Main goal:** Call peaks on the group-level insertion data generated by Step 1. This step uses the SPAN2.0 peak caller (https://github.com/JetBrains-Research/span) to identify regions of significantly concentrated insertions for each group, without background subtraction.  
     * **INPUT:** The per-group insertion coordinates qbed file from Step 1.  
     * **OUTPUT:** Peak files (.peak) for each group, representing putative TF binding sites.

3. ### **step_3_generate_peak_by_group_count_matrices.py**

   * **Main goal:** Quantify the signal within the peaks defined in Step 2. For each group's peak set, this script counts the number of insertions from *every* other group (including controls), creating comprehensive count matrices.  
     * **INPUT:** Per-group peak files from Step 2 and per-group insertion count bedgraph files from Step 1.  
     * **OUTPUT:** A peak-by-group insertion count matrix for each group's peak set.

4. ### **step_4_DESeq2_Diff_Peaks_HOMER-Annotations_and_Motifs.R**

   * **Main goal:** Perform extensive downstream analysis, including differential peak calling, peak annotation, and motif discovery. This script defines final TF binding sites by comparing experimental groups to a control, identifies group-specific peaks, annotates peak locations with HOMER, and performs motif enrichment analysis.  
     * **INPUT:** Peak-by-group count matrices from Step 3 and the annotation file.  
     * **OUTPUT:** Final lists of significant and group-specific peaks, comprehensive summary tables, publication-quality plots (heatmaps, bar plots), and HOMER annotation/motif analysis results.


<img width="4000" height="3670" alt="overview_of_analysis_method_07-11-2025" src="https://github.com/user-attachments/assets/38bfe237-9f1b-4b1a-b39c-f5b79d9da212" />

---

## **Table of Contents**

* [Overview of the Method](#overview-of-the-method)  
* [Script 1: step_1_raw_qbed_to_insertion_maps.py](#script-1-step_1_raw_qbed_to_insertion_mapspy)  
* [Script 2: step_2_run_span_peak_caller.sh](#script-2-step_2_run_span_peak_callersh)  
* [Script 3: step_3_generate_peak_by_group_count_matrices.py](#script-3-step_3_generate_peak_by_group_count_matricespy)  
* [Script 4: step_4_DESeq2_Diff_Peaks_HOMER-Annotations_and_Motifs.R](#script-4-step_4_deseq2_diff_peaks_homer-annotations_and_motifsr)

---

## **Overview of the Method**

* This method leverages self-reporting transposon (SRT) technology.  
* An SRT is "self-reporting" because it contains a promoter that drives the transcription of RNA containing the junction of the transposon's terminal repeat and the downstream genomic DNA.  
* Sequencing this RNA maps the transposon insertion site, which represents the approximate TF binding site.

The method is a pooled, antibody-independent method to map TFs. Because both the sample barcode and the SRT barcode are inserted into genomic DNA, cells from different conditions can be combined following transfection/electroporation if they have distinct sample barcodes.


**Workflow Summary:**

1. **Transfection:** Samples are transfected with a large, diverse pool of plasmids. Each pool contains a unique sample barcode but many SRT barcodes.  
2. **Pooling:** All samples, each with its unique sample barcode, are pooled after transfection.  
3. **Library Prep & Sequencing:** The workflow is RNA extraction, cDNA synthesis, SRT amplification, library preparation, and 2x150bp sequencing.  
4. **Demultiplexing:** Post-sequencing, reads are assigned to their original samples based on the sample barcode.  
5. **Mapping:** The unique transposon insertion sites are identified by their genomic coordinates and the SRT barcode, representing the location and signal of a TF binding event, respectively.

**Schematic of PAINT-seq:**
[paint-seq-schematic.tiff](https://github.com/user-attachments/files/22176805/paint-seq-schematic.tiff)


---

## **Script 1: step_1_raw_qbed_to_insertion_maps.py**

This is a processing pipeline that combines SRT barcode correction and assignment to the fragment that is most proximal or at the transposon from which the transcritpt was derived.

**Major steps:**

1. Input loading, sample barcode correction, annotation, and per-sample partitioning.  
2. For each sample:  
   a. Fragment-based peak calling with CCaller through pyCallingCards to identify regions of interest.
      - Fragment-based peak calling served to identify regions of insertions to make the assignments of each SRT barcode to the single fragment coordinate that is most proximal to the transposon.
        
   b. SRT barcode correction.

   c. Generation of 1-bp unique insertion site maps for each SRT barcode per sample using strand-aware logic of assignment.  
4. Aggregation of per-sample insertion maps by experimental group.  
5. Generation of bedGraph, BigWig, and qbed files for visualization and downstream analysis.

### **Commmand-line Dependencies**
| Tool              | Version   |
|-------------------|-----------|
| bedtools          | 2.31.1    |

**Other Dependencies**
* hg38.chrom.sizes and hg38.chrom.sizes.fa.fai files. Available for download in this repo.


### **Usage**

python step_1_raw_qbed_to_insertion_maps.py \  
    --input_dir /path/to/qbed_files \  
    --output_dir /path/to/results \  
    --annotation_file /path/to/annotation_file.tsv \  
    --chrom_sizes /path/to/hg38.chrom.sizes \  
    --workers 4 \  
    --sample_barcode_dist_threshold 2 \  
    --srt_bc_dist_threshold 1 \  
    --min_rows_threshold 50000 \  
    --sum_window_size 50 

### **Arguments**

* --input_dir: Directory containing input .qbed, .bed, .qbed.gz, or .bed.gz files.  
* --output_dir: Directory where output files will be written.  
* --annotation_file: Path to the annotation file (TSV/CSV with header: library_name,sample_barcode,sample_name,group_name).  
* --chrom_sizes: Path to a chromosome sizes file (e.g., hg38.chrom.sizes).  
* --workers: Number of parallel worker processes (default: 10).  
* --sample_barcode_dist_threshold: Max Hamming distance for correcting sample barcodes (default: 2).  
* --srt_bc_dist_threshold: Max Hamming distance for SRT barcode (UMI) clustering with UMI-tools (default: 1).  
* --min_rows_threshold: Minimum number of fragments for a sample to be processed (default: 50000).  
* --sum_window_size: Window size (bp) for binned summary BigWig tracks (default: 50).  
* Additional parameters for the internal pycallingcards peak caller (--pvalue_cutoff, --extend, etc.) are available.


### **Example Annotation File**
| library_name       | sample_barcode | sample_name                 | group_name   |
|--------------------|----------------|-----------------------------|--------------|
| Library_1 | AAGGCAGACG     | Pool_A_Unfused_HyPBase        | HyPBase      |
| Library_2 | AAGATTAGAC     | Pool_B_JUN       | JUN      |
- library_name originates from raw sequencing pre-processing and alignment.
  
### **Core Logic: Defining the 1-bp Insertion Site**

For each unique SRT barcode within a fragment-based peak, the script identifies the single coordinate most proximal to the actual insertion event based on strand of the transposon:

* For **'+' strand** transposon fragments, the read direction is 5' <- 3'. The end coordinate in the qbed is the true end of the read. The script selects the **minimum end coordinate** across all fragments for that SRT barcode.  
* For **'-' strand** transposon fragments, the read direction is 5' -> 3'. The start coordinate in the qbed is the true end of the read. The script selects the **maximum start coordinate** across all fragments for that SRT barcode.
   * This is oppositie of convention because the strand refers to the strand of the transposon, not the read. For example, the read is on the - strand if the transposon is on the + strand.
 
This process results in a single, representative 1-bp coordinate for each unique SRT barcode in the region.

#### **Summary:**
  - For a **'+'** strand row in the qbed:
    - **Transposon** is inserted on the **'+'** strand.
    - R2 read is moving  **5' <- 3'**.
    - **'end' coordinate** is the true end of the read.
    - **Smallest 'end' coordinate** (most upstream) is the closest to the transposon.

  - For a **'-'** strand row in the qbed:
    - **Transposon** is inserted on the **'-'** strand.
    - R2 read is moving  **5' -> 3'**.
    - **'start' coordinate** is the true end of the read.
    - **Largest start coordinate** (most downstream) is the closest to the transposon.


### **Output Directories**

* collapsed_fragments_per_sample/: Intermediate partitioned data for each sample.  
* fragment_peaks_per_sample/: Intermediate fragment-based peaks for each sample.  
* raw_unique_insertions_per_sample_bedgraph/ & ..._bigwig/  **Bedgraph is an input for Step 3.**
* raw_unique_insertion_count_per_group_bedgraph/ & ..._bigwig/  
* raw_unique_insertion_count_per_group_qbed/: **Input for Step 2.**  
* size_normalized_unique_insertions_per_group_bedgraph/ & ..._bigwig/  
* binned_normalized_count_sum_bigwig.../: Optional binned tracks for visualization.

* **The JBR genome browser** is recommended for visualization of peaks and bigwig tracks, available here https://github.com/JetBrains-Research/jbr .

---

## **Script 2: step_2_run_span_peak_caller.sh**

This script runs the SPAN2.0 peak caller (https://github.com/JetBrains-Research/span) on the per-group qbed files generated in Step 1 to identify regions of significant insertion concentration. These are used to determine sites above the unfused transposase (HyPBase) background control.

### **Installation of SPAN2.0**
- span-2.0.6652.jar was used.
- See https://github.com/JetBrains-Research/span for details.
- Installation of Java is required.
  
### **Usage**

bash step_2_run_span_peak_caller.sh \  
    -j /path/to/span.jar \  
    -i /path/to/step1/raw_unique_insertion_count_per_group_qbed \  
    -o /path/to/span_peak_output \  
    -c /path/to/hg38.chrom.sizes \  
    -b 50 \  
    -f 0.01

### **Arguments**

* -j: Path to the SPAN jar file.  
* -i: Input directory containing .qbed files from Step 1.  
* -o: Directory for output peak files.  
* -c: Path to the chromosome sizes file.  
* -b: Bin size for SPAN analysis (default: 50).  
* -f: False Discovery Rate (FDR) cutoff (default: 0.01).

### **Output**

* A .span.peak file for each input group, containing the coordinates of called peaks. This is the **input for Step 3**.

---

## **Script 3: step_3_generate_peak_by_group_count_matrices.py**

This script takes the peaks called for each group (from Step 2) and the raw unique insertion count bedgraph files (from Step 1) to quantify the number of insertions from all other groups that fall within each group's peak set. This generates a peak by group matrix for each group's peak set, which allows for DESeq2 style differential peak calling.


### **Usage**

python step_3_generate_peak_by_group_count_matrices.py \  
    --peak_dir /path/to/span_peak_output \  
    --peak_suffix _b50.span.peak \  
    --bedgraph_dir /path/to/step1/raw_unique_insertion_count_per_group_bedgraph \  
    --output_dir /path/to/peak_matrices_output \  
    --annotation_file /path/to/annotation_file.tsv \  
    --workers 12

### **Arguments**

* --peak_dir: Directory containing SPAN2.0 peak files from Step 2.  
* --peak_suffix: Suffix of the peak files to use (e.g., _b50.span.peak).  
* --bedgraph_dir: Directory with per-group bedGraph files from Step 1.  
* --output_dir: Directory to save output files.  
* --annotation_file: The same annotation file used previously.  
* --workers: Number of parallel worker processes.

### **Output**

* per_group_peak_matrices/: A directory containing a TSV file for each experimental group (e.g., GroupName_peak_matrix.tsv). Each file is a matrix with the group's peaks as rows and insertion counts from all groups as columns. This is the **input for Step 4**.
  
---

## **Script 4: step_4_DESeq2_Diff_Peaks_HOMER-Annotations_and_Motifs.R**

This is the final analysis script that performs differential analysis, annotation, and visualization.
Make sure that HOMER is installed and its /bin directory is in the PATH.

### **Dependencies**
This script was tested with the following R package versions and R version 4.4.1 (2024-06-14).  
Platform: aarch64-apple-darwin20

Other versions may work.

| R Package         | Version  |
|-------------------|----------|
| data.table        | 1.17.4   |
| purrr             | 1.0.2    |
| stringr           | 1.5.1    |
| tibble            | 3.2.1    |
| DESeq2            | 1.46.0   |
| tidyverse         | 2.0.0    |
| parallel          | 4.4.1    |
| ComplexHeatmap    | 2.22.0   |
| RColorBrewer      | 1.1.3    |
| circlize          | 0.4.16   |
| GenomicRanges     | 1.58.0   |
| viridis           | 0.6.5    |
| janitor           | 2.2.0    |

**External Dependency:**  
- **HOMER**: Must be installed and accessible via command line. Used for genomic annotation and motif discovery.

## **Workflow**
1. **Normalization:** Calculates size factors from total raw insertions from the raw insertion count bedgraph files of Step 1 and normalizes the count matrices from Step 3\.  
2. **Differential Analysis:** Uses DESeq2 to perform pairwise comparisons for each group's peak set against a control group and all other experimental groups.  
3. **Significant Peak Identification:** Filters results to identify peaks significantly enriched over the control (HyPBase) and peaks that are enriched for each group relative to all others.  
4. **Peak Annotation & Motif Analysis:** Uses HOMER to annotate the genomic location of significant peaks and perform *de novo* motif discovery.  

### **Key Outputs**
* DESeq2_results_by_group/: Detailed DESeq2 results for all pairwise comparisons.  
* normalized_peak_matrices/: The normalized count matrices.  
* COMBINED_all_Group_vs_Control_results.csv: A master table of all peaks found to be significant over the control.  
* group_specific_peaks_summary.csv: A master table of peaks found to be specific to a single group compared to all others.  
* HOMER/: A directory containing:  
  * Per_Group_Annotations/: Genomic annotation for each group's significant peaks.  
  * HOMER_motif_discovery/: Motif enrichment results.  
  * HOMER_promoter_bound_genes...csv: Lists of protein-coding genes with significant peaks in their promoter regions.  
 
